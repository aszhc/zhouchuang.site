---
title: nginx åŸºç¡€å¤‡å¿˜
date: 2024-08-17 23:08:12
permalink: /pages/982f3a/
categories:
  - nginx
tags:
  - nginx
  - è´Ÿè½½å‡è¡¡
  - åå‘ä»£ç†
author: 
  name: ZhouChuang
  link: https://github.com/aszhc
---

Nginx æ˜¯ä¸€ä¸ªé«˜æ€§èƒ½çš„HTTPå’Œåå‘ä»£ç†æœåŠ¡å™¨ï¼ŒNginx ä¸“ä¸ºæ€§èƒ½ä¼˜åŒ–è€Œå¼€å‘ï¼Œæ”¯æŒ Epoll æ¨¡å‹ï¼Œèƒ½ç»å—é«˜è´Ÿè½½çš„è€ƒéªŒï¼Œæœ‰æŠ¥å‘Šè¡¨æ˜èƒ½æ”¯æŒé«˜è¾¾ 50,000ä¸ªå¹¶å‘è¿æ¥æ•°ã€‚Nginx å…·æœ‰å¾ˆé«˜çš„ç¨³å®šæ€§,å…¶å®ƒHTTPæœåŠ¡å™¨å½“é‡åˆ°è®¿é—®çš„å³°å€¼,æˆ–è€…æœ‰äººæ¶æ„å‘èµ·æ…¢é€Ÿè¿æ¥æ—¶,ä¹Ÿå¾ˆå¯èƒ½ä¼šå¯¼è‡´æœåŠ¡å™¨ç‰©ç†å†…å­˜è€—å°½é¢‘ç¹äº¤æ¢,å¤±å»å“åº”åªèƒ½é‡å¯æœåŠ¡å™¨.ä¾‹å¦‚å½“å‰Apacheä¸€æ—¦ä¸Šåˆ°200ä¸ªä»¥ä¸Šè¿›ç¨‹,webå“åº”é€Ÿåº¦å°±æ˜æ˜¾éå¸¸ç¼“æ…¢äº†ã€‚è€ŒNginxé‡‡å–äº†åˆ†é˜¶æ®µèµ„æºåˆ†é…æŠ€æœ¯,ä½¿å¾—å®ƒçš„CPUä¸å†…å­˜å ç”¨ç‡éå¸¸ä½ã€‚Nginxå®˜æ–¹è¡¨ç¤ºä¿æŒ10,000ä¸ªæ²¡æœ‰æ´»åŠ¨çš„è¿æ¥,å®ƒåªå 2.5Må†…å­˜,æ‰€ä»¥ç±»ä¼¼DOSè¿™æ ·çš„æ”»å‡»å¯¹Nginxæ¥è¯´åŸºæœ¬ä¸Šæ˜¯æ¯«æ— ç”¨å¤„çš„ã€‚Nginxæ”¯æŒçƒ­éƒ¨ç½²,å®ƒçš„å¯åŠ¨ç‰¹åˆ«å®¹æ˜“, å¹¶ä¸”å‡ ä¹å¯ä»¥åšåˆ°7*24ä¸é—´æ–­è¿è¡Œ,å³ä½¿è¿è¡Œæ•°ä¸ªæœˆä¹Ÿä¸éœ€è¦é‡æ–°å¯åŠ¨ã€‚

## é…ç½®æ–‡ä»¶

* å…¨å±€å—ï¼šé…ç½®å½±å“nginxå…¨å±€çš„æŒ‡ä»¤ã€‚ä¸€èˆ¬æœ‰è¿è¡ŒnginxæœåŠ¡å™¨çš„ç”¨æˆ·ç»„ï¼Œnginxè¿›ç¨‹pidå­˜æ”¾è·¯å¾„ï¼Œæ—¥å¿—å­˜æ”¾è·¯å¾„ï¼Œé…ç½®æ–‡ä»¶å¼•å…¥ï¼Œå…è®¸ç”Ÿæˆworker processæ•°ç­‰ã€‚
* event å—ï¼šé…ç½®å½±å“nginxæœåŠ¡å™¨æˆ–ä¸ç”¨æˆ·çš„ç½‘ç»œè¿æ¥ã€‚æœ‰æ¯ä¸ªè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°ï¼Œé€‰å–å“ªç§äº‹ä»¶é©±åŠ¨æ¨¡å‹å¤„ç†è¿æ¥è¯·æ±‚ï¼Œæ˜¯å¦å…è®¸åŒæ—¶æ¥å—å¤šä¸ªç½‘è·¯è¿æ¥ï¼Œå¼€å¯å¤šä¸ªç½‘ç»œè¿æ¥åºåˆ—åŒ–ç­‰ã€‚epoll
* http å—ï¼šå¯ä»¥åµŒå¥—å¤šä¸ªserverï¼Œé…ç½®ä»£ç†ï¼Œç¼“å­˜ï¼Œæ—¥å¿—å®šä¹‰ç­‰ç»å¤§å¤šæ•°åŠŸèƒ½å’Œç¬¬ä¸‰æ–¹æ¨¡å—çš„é…ç½®ã€‚å¦‚æ–‡ä»¶å¼•å…¥ï¼Œmime-typeå®šä¹‰ï¼Œæ—¥å¿—è‡ªå®šä¹‰ï¼Œæ˜¯å¦ä½¿ç”¨sendfileä¼ è¾“æ–‡ä»¶ï¼Œè¿æ¥è¶…æ—¶æ—¶é—´ï¼Œå•è¿æ¥è¯·æ±‚æ•°ç­‰ã€‚
* http.server å—ï¼šé…ç½®è™šæ‹Ÿä¸»æœºçš„ç›¸å…³å‚æ•°ï¼Œä¸€ä¸ªhttpä¸­å¯ä»¥æœ‰å¤šä¸ªserverã€‚
* http.server.location å—ï¼šé…ç½®è¯·æ±‚çš„è·¯ç”±ï¼Œä»¥åŠå„ç§é¡µé¢çš„å¤„ç†æƒ…å†µã€‚



```nginx
#user  nobody;          # nginxç”¨æˆ·åŠç»„,å¦‚æœç”¨æˆ·å’Œç»„åä¸€æ ·å¯åªå†™ä¸€ä¸ª    
worker_processes  1;    # å®šä¹‰äº†nginxå¯¹å¤–æä¾›webæœåŠ¡æ—¶çš„workerè¿›ç¨‹æ•°ã€‚
                        # æœ€ä¼˜å€¼å–å†³äºè®¸å¤šå› ç´ ï¼ŒåŒ…æ‹¬ï¼ˆä½†ä¸é™äºï¼‰CPUæ ¸çš„æ•°é‡ã€å­˜å‚¨æ•°æ®çš„ç¡¬ç›˜ æ•°é‡åŠè´Ÿè½½æ¨¡å¼ã€‚
                        # ä¸èƒ½ç¡®å®šçš„æ—¶å€™ï¼Œå°†å…¶è®¾ç½®ä¸ºå¯ç”¨çš„CPUæ ¸å¿ƒæ•°å°†æ˜¯ä¸€ä¸ªå¥½çš„å¼€å§‹ï¼ˆè®¾ç½®ä¸ºâ€œautoâ€å°†å°è¯•è‡ªåŠ¨æ£€æµ‹å®ƒï¼‰
#error_log  logs/error.log;
#error_log  logs/error.log  notice;
#error_log  logs/error.log  info;

#pid        logs/nginx.pid;


events {
    worker_connections  1024;   # æ¯ä¸ªè¿›ç¨‹çš„æœ€å¤§è¿æ¥æ•°
}


http {
    include       mime.types;               # æ–‡ä»¶æ‰©å±•åä¸æ–‡ä»¶ç±»å‹æ˜ å°„è¡¨
    default_type  application/octet-stream; 
    server_tokens off; # éšè—è½¯ä»¶ç‰ˆæœ¬å·

    #log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '  # å®šä¹‰è®¿é—®æ—¥å¿—æ ¼å¼
    #                  '$status $body_bytes_sent "$http_referer" '
    #                  '"$http_user_agent" "$http_x_forwarded_for"';

    #access_log  logs/access.log  main;             # å®šä¹‰æ—¥å¿—æ–‡ä»¶

    sendfile        on;         # å¼€å¯é«˜æ•ˆæ–‡ä»¶ä¼ è¾“æ¨¡å¼
    #tcp_nopush     on;         

    #keepalive_timeout  0;
    keepalive_timeout  65;  # é•¿è¿æ¥è¶…æ—¶æ—¶é—´

    #gzip  on;

    server {
        listen       80;
        server_name  localhost;

        #charset koi8-r;

        #access_log  logs/host.access.log  main;

        location / {
            root   html;       # $document_rootç›®å½•
            index  index.html index.htm;
        }

        #error_page  404              /404.html;

        # redirect server error pages to the static page /50x.html
        #
        error_page   500 502 503 504  /50x.html;
        location = /50x.html {
            root   html;
        }

        # proxy the PHP scripts to Apache listening on 127.0.0.1:80
        #
        #location ~ \.php$ {
        #    proxy_pass   http://127.0.0.1;
        #}

        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000
        #
        #location ~ \.php$ {
        #    root           html;
        #    fastcgi_pass   127.0.0.1:9000;
        #    fastcgi_index  index.php;
        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;
        #    include        fastcgi_params;
        #}

        # deny access to .htaccess files, if Apache's document root
        # concurs with nginx's one
        #
        #location ~ /\.ht {
        #    deny  all;
        #}
    }


    # another virtual host using mix of IP-, name-, and port-based configuration
    #
    #server {
    #    listen       8000;
    #    listen       somename:8080;
    #    server_name  somename  alias  another.alias;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}


    # HTTPS server
    #
    #server {
    #    listen       443 ssl;
    #    server_name  localhost;

    #    ssl_certificate      cert.pem;
    #    ssl_certificate_key  cert.key;

    #    ssl_session_cache    shared:SSL:1m;
    #    ssl_session_timeout  5m;

    #    ssl_ciphers  HIGH:!aNULL:!MD5;
    #    ssl_prefer_server_ciphers  on;

    #    location / {
    #        root   html;
    #        index  index.html index.htm;
    #    }
    #}

}
```

## è™šæ‹Ÿä¸»æœº

è™šæ‹Ÿä¸»æœºæŠ€æœ¯å¯ä»¥å°†ç½‘ç»œä¸Šä¸€å°è®¡ç®—æœºåˆ†æˆå¤šä¸ªè™šæ‹Ÿä¸»æœºï¼Œæ¯ä¸ªè™šæ‹Ÿä¸»æœºå¯ä»¥ç‹¬ç«‹å¯¹å¤–æä¾›wwwæœåŠ¡ï¼Œè¿™æ ·å°±ä»¥å®ç°ä¸€å°ä¸»æœºå¯¹å¤–æä¾›å¤šä¸ªwebæœåŠ¡

è™šæ‹Ÿä¸»æœºå¯ä»¥ä½¿å¾—å¤šä¸ªç½‘ç«™è¿è¡Œåœ¨åŒä¸€å°æœåŠ¡å™¨ä¸Šï¼Œä»è€ŒèŠ‚çœç¡¬ä»¶èµ„æºå’Œæˆæœ¬ã€‚

åŒæ—¶ï¼Œè™šæ‹Ÿä¸»æœºä¹Ÿæä¾›äº†æ›´çµæ´»çš„é…ç½®æ–¹å¼ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„ç½‘ç«™è®¾ç½®ä¸åŒçš„Nginxé€‰é¡¹å’Œé™åˆ¶

æ¯ä¸ªè™šæ‹Ÿä¸»æœºä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œäº’ä¸å½±å“ã€‚

### åŸºäºåŸŸå

åŸºäºåŸŸåçš„è™šæ‹Ÿä¸»æœºï¼šæ‰€æœ‰ä¸»æœºçš„å¥—æ¥å­—å®Œå…¨ä¸€æ ·ï¼Œä»…ä»¥å®¢æˆ·ç«¯è®¿é—®çš„åŸŸåè¿›è¡ŒåŒºåˆ†

```nginx
# è™šæ‹Ÿä¸»æœº 1
server {
    listen       80 default_server;   # default_serverï¼šé»˜è®¤ä¸»æœº
    server_name  www.zc.com;
    access_log   /www/zc/logs/access.log main;
    error_log    /www/zc/logs/error.log;
    location / {
        root   /www/zc;
        index  index.html index.htm;
    }
}

# è™šæ‹Ÿä¸»æœº 2
server {
    listen       80;
    server_name  blog.zc.com;
    access_log   /www/blog/logs/access.log main;
    error_log    /www/blog/logs/error.log;
    location / {
        root   /www/blog;
        index  index.html index.htm;
    }
}

# è™šæ‹Ÿä¸»æœº 3
server {
    listen       80;
    server_name  cloud.zc.com;
    access_log   /www/cloud/logs/access.log main;
    error_log    /www/cloud/logs/error.log;
    location / {
        root   /www/cloud;
        index  index.html index.htm;
    }
}
```

### åŸºäºIP

æ¯ä¸ªä¸»æœºå¥—æ¥å­—ä¸­çš„IP ä¸ä¸€æ ·ï¼Œä»¥IPæ¥åŒºåˆ†

è§£ææ—¶å°†ä¸åŒçš„åŸŸåè§£æåˆ°å¯¹åº”çš„IPä¸Šï¼Œè¦æ±‚æœåŠ¡å™¨è¦æœ‰å¤šä¸ªIP

```nginx
server {
    listen      192.168.10.11:80;
    server_name  web.11.com;
    location / {
        root    /web11/html; 
        index  index.html index.htm;
    }
}

server {
    listen       192.168.10.12:80;
    server_name  web.12.com;
    location / {
        root   /web12/html;
        index index.html index.htm;
    }
}
```

### åŸºäºç«¯å£

æ¯ä¸ªä¸»æœºå¥—æ¥å­—ä¸­çš„ç«¯å£ä¸ä¸€æ ·ï¼Œä»¥ç«¯å£æ¥åŒºåˆ†ï¼Œåœ¨è®¿é—®æ—¶è¦å¸¦ç«¯å£

```nginx
server {
    listen       1111;
    server_name  web.11.com;
    location / {
        root /www/11/html;
        index index.html index.htm;
    }
}

server {
    listen       1212;
    server_name  web.12.com;
    location / {
        root /www/12/html;
        index index.html index.htm;
    }
}
```

## è®¿é—®æ§åˆ¶

> ç”¨æˆ·è®¤è¯

```nginx
location / {
    root   html; 
    index  index.html index.htm;
    auth_basic "user&pass";                               # åŸºæœ¬è®¤è¯
    auth_basic_user_file  /usr/local/nginx/passwd.db;     # å­˜æ”¾ç”¨æˆ·åå’Œå¯†ç çš„æ–‡ä»¶
}
```

> è®¿é—®æ§åˆ¶

æ–¹æ³•ä¸€ï¼šdeny/allow

æ§åˆ¶é€»è¾‘: ä»ä¸Šåˆ°ä¸‹ï¼ŒåŒ¹é…åˆ°å³æ‰§è¡Œç›¸åº”çš„ç­–ç•¥

```nginx
location / {
    root    html;
    index   index.html index.htm;
    allow   192.168.10.0/24;  # ä»…å…è®¸è¿™ä¸ª ip æ®µè®¿é—®
    deny    all;
}
```

æ–¹æ³•äºŒï¼šé»‘/ç™½åå•

å¯ä»¥ä½¿ç”¨geoæ¨¡å—å®šä¹‰ä¸€ä¸ªè®¿é—®æ§åˆ¶çš„é»‘/ç™½åå•

geoæŒ‡ä»¤å¯ä»¥æ ¹æ®å®¢æˆ·ç«¯çš„IPåœ°å€æ¥ç»™å˜é‡å®šä¹‰ä¸åŒçš„å€¼ï¼Œè¯­æ³•å¦‚ä¸‹ï¼š

```nginx
geo $black_list {
    default     0;
    192.168.10.11   1;
    127.0.0.1       1;
}

server {
    listen       80;
    server_name  www.qf.com;
    root         /usr/share/nginx/html;

    if ($black_list) { # ç¦æ­¢ 192.168.10.11 å’Œ 127.0.0.1 è®¿é—®
        return 403;
    }
	...
}
```

> é€Ÿåº¦é™åˆ¶

æˆ‘ä»¬å¯ä»¥åˆ©ç”¨ geo å’Œ map æ–¹ä¾¿çš„å®ç°åˆ†æ®µé™é€Ÿ:

```nginx
...
geo $limit {
    default 2;
    192.168.10.11 1;
    192.168.10.13 0;
}

map $limit $rate {
    2   128k;
    1   1m;
    0   0;
}

server {
    ...
    location   /download/ {
        autoindex  on;       # å½“ç›®å½•ä¸­æ²¡æœ‰ indexæ–‡ä»¶æ—¶åˆ—å‡ºæ–‡ä»¶åˆ—è¡¨, é»˜è®¤ä¸º off
        limit_rate  $rate;
    }
    ...
}
```

limit_rate_afteræŒ‡ä»¤ï¼š

å°±æ˜¯åœ¨ä¸‹è½½å¤šå°‘å†…å®¹åå†ä»¥limit_rateé™åˆ¶çš„é€Ÿç‡ä¸‹è½½ï¼Œå¤šç”¨äºæµè§ˆè§†é¢‘

```nginx
location /flv/ {
    limit_rate_after 500k;
    limit_rate       50k;
}
```

## é™æµ

æµé‡é™åˆ¶å¯ä»¥ç”¨ä½œå®‰å…¨ç›®çš„ï¼Œæ¯”å¦‚å¯ä»¥å‡æ…¢æš´åŠ›å¯†ç ç ´è§£çš„é€Ÿç‡ã€‚é€šè¿‡å°†ä¼ å…¥è¯·æ±‚çš„é€Ÿç‡é™åˆ¶ä¸ºçœŸå®ç”¨æˆ·çš„å…¸å‹å€¼ï¼Œå¹¶æ ‡è¯†ç›®æ ‡URLåœ°å€(é€šè¿‡æ—¥å¿—)ï¼Œè¿˜å¯ä»¥ç”¨æ¥æŠµå¾¡ DDOS æ”»å‡»ã€‚

æ›´**å¸¸è§çš„æƒ…å†µï¼Œè¯¥åŠŸèƒ½è¢«ç”¨æ¥ä¿æŠ¤ä¸Šæ¸¸åº”ç”¨æœåŠ¡å™¨ä¸è¢«åŒæ—¶å¤ªå¤šç”¨æˆ·è¯·æ±‚æ‰€å‹å®ã€‚**

### nginxé™æµé…ç½®

`ngx_http_limit_req_module` æ¨¡å—æä¾›é™åˆ¶è¯·æ±‚å¤„ç†é€Ÿç‡èƒ½åŠ›, è¯¥æ¨¡å—ä½¿ç”¨äº†æ¼æ¡¶ç®—æ³•(leaky bucket)ã€‚

æ¼æ¡¶ç®—æ³•æ€è·¯å¾ˆç®€å•: æ°´åŠ å…¥åˆ°æ¼æ¡¶é‡Œ(è¯·æ±‚å…¥é˜Ÿ)ï¼Œæ¼æ¡¶ä»¥å›ºå®šçš„é€Ÿåº¦å‡ºæ°´(å¤„ç†è¯·æ±‚)ï¼Œå½“æ°´åŠ çš„è¿‡å¿«ï¼Œåˆ™ä¼šç›´æ¥æº¢å‡º(æ‹’ç»è¯·æ±‚)ï¼Œå¯ä»¥çœ‹å‡ºæ¼æ¡¶ç®—æ³•èƒ½å¼ºè¡Œé™åˆ¶æ•°æ®çš„ä¼ è¾“é€Ÿç‡ã€‚

æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `limit_req_zone` å’Œ `limit_req` ä¸¤ä¸ªæŒ‡ä»¤ï¼Œé™åˆ¶å•ä¸ªIPçš„è¯·æ±‚å¤„ç†é€Ÿç‡ã€‚

é…ç½®æ–¹æ³•ï¼š

1. é…ç½®`limit_req_zone`

   ```nginx
   Syntax:	limit_req_zone key zone=name:size rate=rate [sync];
   Default:	â€”
   Context:	http
   ```

   ä¾‹å¦‚ï¼šåœ¨httpå—ä¸­è¿›è¡Œä»¥ä¸‹é…ç½®

   ```nginx
   limit_req_zone $binary_remote_addr zone=one:10m rate=10r/s;
   ```

   è¯´æ˜:

    * key ï¼šå®šä¹‰é™æµå¯¹è±¡ï¼Œ$binary_remote_addr æ˜¯ä¸€ç§keyï¼Œè¡¨ç¤ºåŸºäº remote_addr(å®¢æˆ·ç«¯IP) æ¥åšé™æµï¼Œbinary_ çš„ç›®çš„æ˜¯å‹ç¼©å†…å­˜å ç”¨é‡ã€‚

    * zoneï¼šå®šä¹‰å…±äº«å†…å­˜åŒºæ¥å­˜å‚¨è®¿é—®ä¿¡æ¯ï¼Œ one:10m è¡¨ç¤ºä¸€ä¸ªå¤§å°ä¸º10Mï¼Œåå­—ä¸ºoneçš„å†…å­˜åŒºåŸŸã€‚
      1Mèƒ½å­˜å‚¨16000 IPåœ°å€çš„è®¿é—®ä¿¡æ¯ï¼Œ10Må¯ä»¥å­˜å‚¨16W IPåœ°å€è®¿é—®ä¿¡æ¯ã€‚

    * rate:  ç”¨äºè®¾ç½®æœ€å¤§è®¿é—®é€Ÿç‡ï¼Œrate=10r/s è¡¨ç¤ºæ¯ç§’æœ€å¤šå¤„ç†10ä¸ªè¯·æ±‚ã€‚

      Nginx å®é™…ä¸Šä»¥æ¯«ç§’ä¸ºç²’åº¦æ¥è·Ÿè¸ªè¯·æ±‚ä¿¡æ¯ï¼Œå› æ­¤ 10r/s å®é™…ä¸Šæ˜¯é™åˆ¶ï¼šæ¯100æ¯«ç§’å¤„ç†ä¸€ä¸ªè¯·æ±‚ã€‚

      è¿™æ„å‘³ç€ï¼Œ100æ¯«ç§’å†…ï¼Œä¸€ä¸ªè¯·æ±‚å¤„ç†å®Œåï¼Œè‹¥åç»­åˆæœ‰è¯·æ±‚åˆ°è¾¾ï¼Œå°†æ‹’ç»å¤„ç†è¯¥è¯·æ±‚ã€‚

2. limit_req

   ```nginx
   Syntax:	limit_req zone=name [burst=number] [nodelay | delay=number];
   Default:	â€”
   Context:	http, server, location
   ```

   ä¾‹: åœ¨http/server/locationå—åŠ å…¥ä»¥ä¸‹é…ç½®:

   ```nginx
   server {
       ...
       location /search/ {
           root /www;
           index index.html;
           limit_req zone=one;
       }
       ...
   }
   ```

3. å¤„ç†çªå‘æµé‡

   ä¸Šé¢ä¾‹å­é™åˆ¶ 10r/sï¼Œå¦‚æœæœ‰æ—¶æ­£å¸¸æµé‡çªç„¶å¢å¤§ï¼Œè¶…å‡ºçš„è¯·æ±‚å°†è¢«æ‹’ç»ï¼Œæ— æ³•å¤„ç†çªå‘æµé‡ï¼Œå¯ä»¥ç»“åˆ burst å‚æ•°ä½¿ç”¨æ¥è§£å†³è¯¥é—®é¢˜ã€‚

   ```nginx
   å¦‚: limit_req zone=one burst=20;
   ```

   burst è¯‘ä¸ºçªå‘ã€çˆ†å‘ï¼Œè¡¨ç¤ºåœ¨è¶…è¿‡è®¾å®šçš„å¤„ç†é€Ÿç‡åèƒ½é¢å¤–å¤„ç†çš„è¯·æ±‚æ•°ã€‚å½“ rate=10r/s æ—¶ï¼Œå°†1sæ‹†æˆ10ä»½ï¼Œå³æ¯100mså¯å¤„ç†1ä¸ªè¯·æ±‚ã€‚

### é™åˆ¶è¿æ¥æ•°

`ngx_http_limit_conn_module` æä¾›äº†é™åˆ¶è¿æ¥æ•°çš„èƒ½åŠ›ï¼Œåˆ©ç”¨ `limit_conn_zone` å’Œ `limit_conn` ä¸¤ä¸ªæŒ‡ä»¤å³å¯ã€‚

å®˜æ–¹ä¾‹å­ï¼š

```nginx
limit_conn_zone $binary_remote_addr zone=perip:10m;
limit_conn_zone $server_name zone=perserver:10m;
server {
    ...
    limit_conn perip 10;
    limit_conn perserver 100;
    ...
}
```

è¯´æ˜:
`limit_conn perip 10` ä½œç”¨çš„key æ˜¯ `$binary_remote_addr`ï¼Œè¡¨ç¤ºé™åˆ¶å•ä¸ªIPåŒæ—¶æœ€å¤šèƒ½æŒæœ‰10ä¸ªè¿æ¥ã€‚
`limit_conn perserver 100` ä½œç”¨çš„keyæ˜¯ `$server_name`ï¼Œè¡¨ç¤ºè™šæ‹Ÿä¸»æœº(server) åŒæ—¶èƒ½å¤„ç†å¹¶å‘è¿æ¥çš„æ€»æ•°ã€‚
éœ€è¦æ³¨æ„çš„æ˜¯ï¼šåªæœ‰å½“ request header è¢«åç«¯serverå¤„ç†åï¼Œè¿™ä¸ªè¿æ¥æ‰è¿›è¡Œè®¡æ•°ã€‚

## ç¬¬ä¸‰æ–¹æ¨¡å—

Nginx çš„ç¬¬ä¸‰æ–¹æ¨¡å—ä¸°å¯Œå¤šæ ·ï¼Œæ‰©å±•äº†å®ƒçš„åŠŸèƒ½å’Œçµæ´»æ€§ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸ç”¨çš„ Nginx ç¬¬ä¸‰æ–¹æ¨¡å—ï¼š

1. **ngx_http_substitutions_filter_module**ï¼šå…è®¸åœ¨å“åº”å†…å®¹ä¸­è¿›è¡Œå­—ç¬¦ä¸²æ›¿æ¢ï¼Œå¯ä»¥ç”¨æ¥ä¿®æ”¹è¿”å›çš„ HTML å†…å®¹ã€‚
2. **ngx_http_headers_more_module**ï¼šæ‰©å±•äº†å¯¹ HTTP å¤´çš„æ§åˆ¶ï¼Œå¯ä»¥æ·»åŠ ã€ä¿®æ”¹æˆ–åˆ é™¤è¯·æ±‚å’Œå“åº”çš„å¤´ä¿¡æ¯ã€‚
3. **ngx_brotli**ï¼šæ”¯æŒ Brotli å‹ç¼©ç®—æ³•ï¼Œè¿™æ˜¯ä¸€ç§æ¯” gzip æ›´é«˜æ•ˆçš„å‹ç¼©æ–¹å¼ã€‚
4. **ngx_pagespeed**ï¼šç”± Google å¼€å‘ï¼Œç”¨äºè‡ªåŠ¨ä¼˜åŒ–ç½‘é¡µæ€§èƒ½ï¼Œå‡å°‘é¡µé¢åŠ è½½æ—¶é—´ã€‚
5. **ngx_cache_purge**ï¼šç”¨äºæ‰‹åŠ¨æ¸…é™¤ Nginx ç¼“å­˜çš„æ¨¡å—ï¼Œå¯ä»¥é€šè¿‡ HTTP è¯·æ±‚æ¸…ç†ç‰¹å®š URL çš„ç¼“å­˜ã€‚
6. **ngx_http_auth_ldap_module**ï¼šç”¨äºé€šè¿‡ LDAP è¿›è¡Œç”¨æˆ·è®¤è¯ï¼Œé€‚ç”¨äºé›†æˆ LDAP ç”¨æˆ·éªŒè¯çš„åœºæ™¯ã€‚
7. **ngx_http_lua_module**ï¼šå…è®¸ä½¿ç”¨ Lua è„šæœ¬æ‰©å±• Nginx çš„åŠŸèƒ½ï¼Œå¯ä»¥ç¼–å†™è‡ªå®šä¹‰é€»è¾‘å’Œå¤„ç†å¤æ‚çš„è¯·æ±‚ã€‚
8. **ngx_http_geoip_module**ï¼šåŸºäº GeoIP æ•°æ®åº“ï¼Œé€šè¿‡ IP åœ°å€å®šä½ç”¨æˆ·çš„åœ°ç†ä½ç½®ï¼Œå¯ç”¨äºåšåœ°ç†ä½ç½®ç›¸å…³çš„å†…å®¹åˆ†å‘ã€‚
9. **ngx_http_redis_module**ï¼šæ”¯æŒå°† Redis ä½œä¸ºåç«¯ç¼“å­˜æœåŠ¡å™¨çš„æ¨¡å—ï¼Œå¯ä»¥ä¸ Redis é›†æˆæ¥å®ç°ç¼“å­˜åŠŸèƒ½ã€‚
10. **ngx_http_image_filter_module**ï¼šæ”¯æŒå›¾åƒå¤„ç†åŠŸèƒ½ï¼Œå¦‚è°ƒæ•´å¤§å°ã€è£å‰ªå’Œè½¬æ¢å›¾åƒæ ¼å¼ï¼Œé€‚åˆåŠ¨æ€å¤„ç†å›¾åƒçš„åœºæ™¯ã€‚

## location

http.server.location å—ï¼šé…ç½®è¯·æ±‚çš„è·¯ç”±ï¼Œä»¥åŠå„ç§é¡µé¢çš„å¤„ç†æƒ…å†µã€‚

locationç”¨äºåŒ¹é…å®¢æˆ·è¯·æ±‚uri

è¯­æ³•ï¼š

```nginx
location [ = | ~ | ~* | ^~ ] uri { ... }
```

| å‚æ•° | è§£é‡Š                                                         |
| ---- | ------------------------------------------------------------ |
| ç©º   | location åæ²¡æœ‰å‚æ•°ç›´æ¥è·Ÿç€ **æ ‡å‡† URI**ï¼Œè¡¨ç¤ºå‰ç¼€åŒ¹é…ï¼Œä»£è¡¨è·Ÿè¯·æ±‚ä¸­çš„ URI ä»å¤´å¼€å§‹åŒ¹é…ã€‚ |
| `=`  | ç”¨äº**æ ‡å‡† URI** å‰ï¼Œè¦æ±‚è¯·æ±‚å­—ç¬¦ä¸²ä¸å…¶ç²¾å‡†åŒ¹é…ï¼ŒæˆåŠŸåˆ™ç«‹å³å¤„ç†ï¼Œnginxåœæ­¢æœç´¢å…¶ä»–åŒ¹é…ã€‚ |
| `^~` | ç”¨äº**æ ‡å‡† URI** å‰ï¼Œå¹¶è¦æ±‚ä¸€æ—¦åŒ¹é…åˆ°å°±ä¼šç«‹å³å¤„ç†ï¼Œä¸å†å»åŒ¹é…å…¶ä»–çš„é‚£äº›ä¸ªæ­£åˆ™ URIï¼Œä¸€èˆ¬ç”¨æ¥åŒ¹é…ç›®å½• |
| `~`  | ç”¨äº**æ­£åˆ™ URI** å‰ï¼Œè¡¨ç¤º URI åŒ…å«æ­£åˆ™è¡¨è¾¾å¼ï¼Œ **åŒºåˆ†**å¤§å°å†™ |
| `~*` | ç”¨äº**æ­£åˆ™ URI** å‰ï¼Œ è¡¨ç¤º URI åŒ…å«æ­£åˆ™è¡¨è¾¾å¼ï¼Œ **ä¸åŒºåˆ†**å¤§å°å†™ |
| `@`  | @ å®šä¹‰ä¸€ä¸ªå‘½åçš„ locationï¼Œ@ å®šä¹‰çš„locaitonåå­—ä¸€èˆ¬ç”¨åœ¨å†…éƒ¨å®šå‘ï¼Œä¾‹å¦‚error_page, try_fileså‘½ä»¤ä¸­ã€‚å®ƒçš„åŠŸèƒ½ç±»ä¼¼äºç¼–ç¨‹ä¸­çš„gotoã€‚ |

* `=` è¡¨ç¤ºç²¾å‡†åŒ¹é…ï¼Œæ¯”å¦‚

  ```nginx
  location = /test {
    return 200 "hello";
  }
  
  # /test ok
  # /test/ not ok
  # /test2 not ok
  # /test/2 not ok
  ```

* `~` è¡¨ç¤ºåŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…ï¼Œæ¯”å¦‚ï¼š

  ```nginx
  location ~ ^/test$ {
    [ configuration ] 
  }
  
  # /test ok
  # /Test not ok
  # /test/ not ok
  # /test2 not ok
  ```

* `~*` è¡¨ç¤ºä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…

  ```nginx
  location ~* ^/test$ {     
  	[ configuration ] 
  }
  
  # /test ok
  # /Test ok
  # /test/ not ok
  # /test2 not ok
  ```

* `^~` è¡¨ç¤º uri ä»¥æŸä¸ªå­—ç¬¦ä¸²å¼€å¤´

  ```nginx
  location ^~ /images/ {    
  	[ configuration ] 
  }
  
  # /images/1.gif ok
  ```

å½“ä½ ä¸ä½¿ç”¨è¿™äº›è¯­æ³•çš„æ—¶å€™ï¼Œåªå†™ uri çš„æ—¶å€™ï¼š

* `/` è¡¨ç¤ºé€šç”¨åŒ¹é…ï¼š

  ```nginx
  location / {     
  	[ configuration ] 
  }
  
  # /index.html ok
  
  
  
  location /test {
      [ configuration ] 
  }
  
  # /test ok
  # /test2 ok
  # /test/ ok
  ```

> åŒ¹é…é¡ºåº

location çš„å®šä¹‰åˆ†ä¸ºä¸¤ç§ï¼š

- å‰ç¼€å­—ç¬¦ä¸²ï¼ˆprefix stringï¼‰
- æ­£åˆ™è¡¨è¾¾å¼ï¼ˆregular expressionï¼‰ï¼Œå…·ä½“ä¸ºå‰é¢å¸¦ `~*` å’Œ `~` ä¿®é¥°ç¬¦çš„



1. æ£€æŸ¥ä½¿ç”¨å‰ç¼€å­—ç¬¦ä¸²çš„ locationsï¼Œåœ¨ä½¿ç”¨å‰ç¼€å­—ç¬¦ä¸²çš„ locations ä¸­é€‰æ‹©æœ€é•¿åŒ¹é…çš„ï¼Œå¹¶å°†ç»“æœè¿›è¡Œå‚¨å­˜

2. å¦‚æœç¬¦åˆå¸¦æœ‰ `=` ä¿®é¥°ç¬¦çš„ URIï¼Œåˆ™ç«‹åˆ»åœæ­¢åŒ¹é…

3. å¦‚æœç¬¦åˆå¸¦æœ‰  `^~` ä¿®é¥°ç¬¦çš„ URIï¼Œåˆ™ä¹Ÿç«‹åˆ»åœæ­¢åŒ¹é…ã€‚

4. ç„¶åæŒ‰ç…§å®šä¹‰æ–‡ä»¶çš„é¡ºåºï¼Œæ£€æŸ¥æ­£åˆ™è¡¨è¾¾å¼ï¼ŒåŒ¹é…åˆ°å°±åœæ­¢

5. å½“æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…ä¸åˆ°çš„æ—¶å€™ï¼Œä½¿ç”¨ä¹‹å‰å‚¨å­˜çš„å‰ç¼€å­—ç¬¦ä¸²



ç®€å•æ€»ç»“å°±æ˜¯ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ä¾æ¬¡ä¸ºï¼ˆåºå·è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰ï¼š

```
1. location =    # ç²¾å‡†åŒ¹é…
2. location ^~   # å¸¦å‚å‰ç¼€åŒ¹é…
3. location ~    # æ­£åˆ™åŒ¹é…ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
4. location ~*   # æ­£åˆ™åŒ¹é…ï¼ˆä¸åŒºåˆ†å¤§å°å†™ï¼‰
5. location /a   # æ™®é€šå‰ç¼€åŒ¹é…ï¼Œä¼˜å…ˆçº§ä½äºå¸¦å‚æ•°å‰ç¼€åŒ¹é…ã€‚
6. location /    # ä»»ä½•æ²¡æœ‰åŒ¹é…æˆåŠŸçš„ï¼Œéƒ½ä¼šåŒ¹é…è¿™é‡Œå¤„ç†
```

### alias

`alias` æŒ‡ä»¤ç”¨äºå®šä¹‰æŒ‡å®šè·¯å¾„çš„æ›¿æ¢è·¯å¾„ã€‚

å¦‚ä¸‹é¢é…ç½®ï¼š

```nginx
location /i/ {
    alias /data/w3/images/;
}
```

â€œ/i/top.gifâ€ å°†ç”± /data/w3/images/top.gif æ–‡ä»¶æ¥å“åº”ã€‚

> root ä¸ alias çš„åŒºåˆ«

å½“æˆ‘ä»¬è¿™æ ·è®¾ç½® `root` çš„æ—¶å€™ï¼š

```nginx
location /i/ {
    root /data/w3;
}
```

å½“è¯·æ±‚ `/i/top.gif` ï¼Œ`/data/w3/i/top.gif` ä¼šè¢«è¿”å›ã€‚

å½“æˆ‘ä»¬è¿™æ ·è®¾ç½® `alias` çš„æ—¶å€™ï¼š

```nginx
location /i/ {
    alias /data/w3/images/;
}
```

å½“è¯·æ±‚ `/i/top.gif` ï¼Œ`/data/w3/images/top.gif` ä¼šè¢«è¿”å›ã€‚

ä¹ä¸€çœ‹ä¸¤è€…å¾ˆåƒï¼Œä½†ç»†ä¸€çœ‹ï¼Œå°±èƒ½çœ‹å‡ºä¸¤è€…çš„åŒºåˆ«ï¼Œroot æ˜¯ç›´æ¥æ‹¼æ¥ `root` + `location` è€Œ alias æ˜¯ç”¨ `alias` æ›¿æ¢ `location`ï¼Œæ‰€ä»¥ root ä¸­æœ€åçš„è·¯å¾„é‡Œæœ‰ `/i/`ï¼Œè€Œ alias ä¸­æœ€åçš„è·¯å¾„é‡Œæ²¡æœ‰ `/i/` ã€‚

> server å’Œ location ä¸­çš„ root

```nginx
http { 
  server {
      listen 80;
    	server_name www.yayujs.com;
    	root /home/www/website/;    # <--
    	location / {
      		root /home/www/ts/;		# <--
	      	index index.html;
    	}
  }
}
```

å¦‚æœä¸¤è€…éƒ½å‡ºç°ï¼Œæ˜¯æ€æ ·çš„ä¼˜å…ˆçº§å‘¢ï¼Ÿ

ç®€å•çš„æ¥è¯´ï¼Œå°±æ˜¯å°±è¿‘åŸåˆ™ï¼Œå¦‚æœ location ä¸­èƒ½åŒ¹é…åˆ°ï¼Œå°±æ˜¯ç”¨ location ä¸­çš„ root é…ç½®ï¼Œå¿½ç•¥ server ä¸­çš„ rootï¼Œå½“ location ä¸­åŒ¹é…ä¸åˆ°çš„æ—¶å€™ï¼Œåˆ™ä½¿ç”¨ server ä¸­çš„ root é…ç½®ã€‚

## URI é‡å†™

Rewrite æ˜¯Nginxæä¾›çš„ä¸€ä¸ªé‡è¦åŸºæœ¬åŠŸèƒ½ï¼Œå…¶åœ¨WebæœåŠ¡å™¨äº§å“ä¸­å‡ ä¹æ˜¯å¿…å¤‡çš„åŠŸèƒ½ï¼Œç”¨äºå®ç°URLçš„é‡å†™ã€‚

URLé‡å†™æ˜¯æŒ‡å°†ä¸€ä¸ªURLè¯·æ±‚é‡æ–°å†™æˆç½‘ç«™å¯ä»¥å¤„ç†çš„å¦ä¸€ä¸ªURLçš„è¿‡ç¨‹ã€‚

rewriteçš„ä¸»è¦åŠŸèƒ½æ˜¯å®ç°URLåœ°å€çš„é‡å®šå‘ã€‚Nginxçš„rewriteåŠŸèƒ½éœ€è¦PCREè½¯ä»¶çš„æ”¯æŒï¼Œå³é€šè¿‡perlå…¼å®¹æ­£åˆ™è¡¨è¾¾å¼è¯­å¥è¿›è¡Œè§„åˆ™åŒ¹é…çš„ã€‚

**rewriteå’Œlocationçš„åŠŸèƒ½æœ‰ç‚¹ç›¸åƒï¼Œéƒ½èƒ½å®ç°è·³è½¬ï¼Œä¸»è¦åŒºåˆ«åœ¨äºrewriteå¸¸ç”¨äºåŒä¸€åŸŸåå†…æ›´æ”¹è·å–èµ„æºçš„è·¯å¾„ï¼Œè€Œlocationæ˜¯å¯¹ä¸€ç±»è·¯å¾„åšæ§åˆ¶è®¿é—®å’Œåå‘ä»£ç†ï¼Œå¯ä»¥proxy_passåˆ°å…¶ä»–æœåŠ¡å™¨ã€‚**

Nginxæä¾›çš„å…¨å±€å˜é‡æˆ–è‡ªå·±è®¾ç½®çš„å˜é‡ï¼Œç»“åˆæ­£åˆ™è¡¨è¾¾å¼å’Œæ ‡å¿—ä½å®ç°urlé‡å†™ä»¥åŠé‡å®šå‘ã€‚ rewriteåªèƒ½æ”¾åœ¨server{},location{},if{}ä¸­ï¼Œ å¹¶ä¸”åªèƒ½å¯¹åŸŸååè¾¹çš„é™¤å»ä¼ é€’çš„å‚æ•°å¤–çš„å­—ç¬¦ä¸²èµ·ä½œç”¨ã€‚

URL é‡å†™è¯­æ³•ï¼š

```nginx
rewrite     <regex>     <replacement>     [flag];
å…³é”®å­—        æ­£åˆ™          æ›¿ä»£å†…å®¹          flagæ ‡è®°
```

* regex ï¼šå¯ä»¥ä½¿ç”¨æ­£åˆ™æˆ–è€…å­—ç¬¦ä¸²æ¥è¡¨ç¤ºç›¸åŒ¹é…çš„åœ°å€ã€‚

* replacementï¼šå¯ä»¥è¡¨ç¤ºé‡å®šå‘çš„åœ°å€ã€‚

* flag ï¼šflagæ ‡å¿—çš„ä½œç”¨æ˜¯ç”¨äºæ§åˆ¶å½“åŒ¹é…åˆ°å¯¹åº”çš„rewriteè§„åˆ™åæ˜¯å¦ç»§ç»­æ£€æŸ¥åç»­çš„rewriteè§„åˆ™ã€‚

  flagå€¼ä¸ºå¦‚ä¸‹å››ç§ï¼Œåˆ†åˆ«æ˜¯ï¼š

    * lastï¼šåœæ­¢å¤„ç†å½“å‰çš„rewriteæŒ‡ä»¤é›†ï¼Œè€Œåé€šè¿‡é‡å†™åçš„è§„åˆ™é‡æ–°å‘èµ·è¯·æ±‚ï¼Œæµè§ˆå™¨åœ°å€æ URLåœ°å€ä¸å˜ã€‚
    * breakï¼šå’ŒbreakæŒ‡ä»¤ä¸€æ ·ï¼Œéƒ½æ˜¯åœæ­¢å¤„ç†å½“å‰ä¸Šä¸‹æ–‡ä¸­çš„å…¶ä»–é‡å†™æ¨¡å—æŒ‡ä»¤ã€‚
    * redirectï¼šå¦‚æœæ›¿æ¢å­—ç¬¦ä¸²ä¸ä»¥â€œ http://â€ï¼Œâ€œ https://â€æˆ–â€œ $schemeâ€ å¼€å¤´ï¼Œè¿”å›å¸¦æœ‰302ä»£ç çš„ä¸´æ—¶é‡å®šå‘ï¼Œæµè§ˆå™¨åœ°å€ä¼šæ˜¾ç¤ºè·³è½¬åçš„URLåœ°å€ã€‚
    * permanentï¼šè¿”å›301ä»£ç çš„æ°¸ä¹…é‡å®šå‘ï¼Œæµè§ˆå™¨åœ°å€æ ä¼šæ˜¾ç¤ºè·³è½¬åçš„URLåœ°å€ã€‚

## é˜²ç›—é“¾

è¦å®ç°é˜²ç›—é“¾ï¼Œéœ€è¦äº†è§£HTTPåè®®ä¸­çš„è¯·æ±‚å¤´çš„Refererå¤´åŸŸã€‚

é€šè¿‡è¯¥å¤´åŸŸçš„å€¼ï¼Œå¯ä»¥æ£€æµ‹åˆ°è®¿é—®ç›®æ ‡èµ„æºçš„æºåœ°å€ã€‚

è¿™æ ·ï¼Œå¦‚æœæˆ‘ä»¬æ£€æµ‹åˆ°Refererå¤´åŸŸä¸­çš„å€¼å¹¶ä¸æ˜¯è‡ªå·±ç«™ç‚¹å†…çš„URLæ—¶å°±é‡‡å–é˜»æ­¢æªæ–½ï¼Œå®ç°é˜²ç›—é“¾ã€‚

ä½†æ˜¯è¦æé†’å¤§å®¶çš„æ˜¯ï¼Œ ä»»ä½•HTTPåè®®å¤´éƒ½ä¼šæœ‰å¯èƒ½è¢«ç¯¡æ”¹ï¼Œå› æ­¤è¿™ç§æ–¹æ³•å¹¶ä¸èƒ½å®Œå…¨çš„é˜»æ­¢ç›—é“¾è¡Œä¸ºã€‚

> å¦‚ä½•é…ç½®é˜²ç›—é“¾ï¼š

Nginxçš„`ngx_http_referer_module`æ¨¡å—ä¸­æä¾›äº†ä¸€ä¸ªæŒ‡ä»¤`valid_referers` ï¼Œç”¨æ¥è·å–Refererå¤´åŸŸä¸­çš„å€¼
å¹¶æ ¹æ®è¯¥å€¼çš„æƒ…å†µç»™Nginxå…¨å±€å˜é‡` $invalid_referer`èµ‹å€¼ã€‚ å¦‚æœRefererå¤´åŸŸä¸­æ²¡æœ‰ç¬¦åˆ`valid_referers`
æŒ‡ä»¤é…ç½®çš„å€¼ï¼Œ`$invalid_referer` å˜é‡å°†ä¼šè¢«èµ‹å€¼ä¸º1ã€‚

è¯­æ³•å¦‚ä¸‹:

```nginx
valid_referers none | blocked | server_names | string ...;
```

* noneï¼šHTTP å¤´ä¸­ä¸å­˜åœ¨ Referer å¤´åŸŸ
* blockedï¼šå­˜åœ¨Refererå¤´åŸŸï¼Œä½†é‡Œé¢çš„å€¼æœ‰å¯èƒ½ç”±äºé˜²ç«å¢™æˆ–è€…ä»£ç†æœåŠ¡å™¨çš„åŸå› è¢«åˆ é™¤æˆ–è€…ä¼ªè£…ã€‚
* server_names:  è®¾ç½®ä¸€ä¸ªæˆ–è€…å¤šä¸ªåŸŸå, æ£€æµ‹Referer å¤´åŸŸçš„å€¼æ˜¯ä¸æ˜¯è¿™äº›åŸŸåä¸­çš„æŸä¸ªã€‚æ”¯æŒä½¿ç”¨é€šé…ç¬¦`*`

ç¤ºä¾‹ï¼š

```nginx
server {
    listen 80;
    server_name yourdomain.com;
    root /var/www/yourdomain.com;

    # å…è®¸çš„ referer
    valid_referers none blocked yourdomain.com *.yourdomain.com;

    location / {
        # æ£€æŸ¥æ˜¯å¦æ˜¯æœ‰æ•ˆçš„ referer
        if ($invalid_referer) {
            return 403; # è¿”å›403 ForbiddençŠ¶æ€ç 
        }

        # æ­£å¸¸å¤„ç†è¯·æ±‚
        try_files $uri $uri/ =404;
    }
}
```

é…ç½®è¯´æ˜ï¼š

1. valid_referersï¼šè¯¥æŒ‡ä»¤æŒ‡å®šå…è®¸çš„ `Referer` æ¥æºã€‚å‚æ•° `none` è¡¨ç¤ºå…è®¸æ—  `Referer` çš„è¯·æ±‚ï¼Œ`blocked` è¡¨ç¤ºå…è®¸æ— æ³•è¯»å– `Referer` çš„è¯·æ±‚ï¼Œ`yourdomain.com` å’Œ `*.yourdomain.com` å…è®¸æ¥è‡ªä½ è‡ªå·±åŸŸåçš„è¯·æ±‚ã€‚
2. **if ($invalid_referer)**ï¼šåˆ¤æ–­å½“å‰è¯·æ±‚çš„ `Referer` æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æœ `Referer` ä¸åœ¨å…è®¸åˆ—è¡¨å†…ï¼ˆå³ `$invalid_referer` å˜é‡ä¸ºçœŸï¼‰ï¼Œåˆ™è¿”å› 403 Forbidden çŠ¶æ€ç ï¼Œæ‹’ç»è®¿é—®ã€‚
3. **try_files**ï¼šç”¨äºå¤„ç†åˆæ³•çš„è¯·æ±‚ï¼Œæ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å› 404 é”™è¯¯ã€‚

<u>é€šè¿‡è¿™ç§é…ç½®ï¼ŒNginx å¯ä»¥æœ‰æ•ˆé˜²æ­¢å…¶ä»–ç½‘ç«™ç›´æ¥å¼•ç”¨ä½ çš„ç½‘ç«™èµ„æºï¼ˆå¦‚å›¾ç‰‡ã€è§†é¢‘ç­‰ï¼‰ã€‚</u>

## å¹³æ»‘å‡çº§

å¯ä»¥åœ¨ä¸ä¸­æ–­æœåŠ¡çš„æƒ…å†µä¸‹,æ–°çš„è¯·æ±‚ä¹Ÿä¸ä¼šä¸¢å¤±,ä½¿ç”¨æ–°çš„ nginx å¯æ‰§è¡Œç¨‹åºæ›¿æ¢æ—§çš„ç‰ˆæœ¬

æ­¥éª¤ï¼š

1. ç¼–è¯‘æ–°ç‰ˆæœ¬ Nginx

   é¦–å…ˆï¼Œéœ€è¦ä¸‹è½½å¹¶ç¼–è¯‘æ–°ç‰ˆæœ¬çš„ Nginxï¼Œç¡®ä¿å…¶äºŒè¿›åˆ¶æ–‡ä»¶å¯ä»¥æ›¿æ¢ç°æœ‰çš„ç‰ˆæœ¬ã€‚

   ```
   ./configure --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --with... (å…¶ä»–å‚æ•°)
   make
   ```

   æ³¨æ„ï¼šä¸è¦æ‰§è¡Œ`make install`ï¼Œå¦åˆ™ä¼šç›´æ¥æ›¿æ¢ç°æœ‰çš„ Nginx äºŒè¿›åˆ¶æ–‡ä»¶

2. å¤‡ä»½ç°æœ‰çš„äºŒè¿›åˆ¶æ–‡ä»¶

   ä»¥é˜²å‡ºç°é—®é¢˜éœ€è¦ä¼šé¦†

   ```bash
   cp /usr/sbin/nginx /usr/sbin/nginx.backup
   ```

3. æ›¿æ¢ Nginx äºŒè¿›åˆ¶æ–‡ä»¶

   å°†æ–°ç¼–è¯‘çš„ Nginx äºŒè¿›åˆ¶æ–‡ä»¶å¤åˆ¶åˆ°ç°æœ‰ Nginx äºŒè¿›åˆ¶æ–‡ä»¶çš„ä½ç½®ã€‚

4. å‘é€ USER2 ä¿¡å·

   å‘é€ `USR2` ä¿¡å·ç»™ Nginx ä¸»è¿›ç¨‹ï¼Œè§¦å‘ Nginx åˆ›å»ºæ–°çš„å·¥ä½œè¿›ç¨‹ï¼ˆworkersï¼‰ï¼Œä»¥ä½¿ç”¨æ–°äºŒè¿›åˆ¶æ–‡ä»¶ã€‚

   ```bash
   kill -USR2 <master_process_id>
   ```

   æ‰§è¡Œåï¼ŒNginx ä¼šå°†å½“å‰ä¸»è¿›ç¨‹çš„ PID æ–‡ä»¶é‡å‘½åï¼Œå¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„ PID æ–‡ä»¶ï¼ˆé€šå¸¸åœ¨ `/usr/local/nginx/logs/nginx.pid`ï¼‰ã€‚

5. éªŒè¯æ–°è¿›ç¨‹

   åœ¨æ–°è¿›ç¨‹å¯åŠ¨åï¼Œå¯ä»¥éªŒè¯å…¶çŠ¶æ€ï¼Œç¡®ä¿æ–°ç‰ˆæœ¬å·¥ä½œæ­£å¸¸ã€‚å¦‚æœä¸€åˆ‡æ­£å¸¸ï¼Œå¯ä»¥åœæ­¢æ—§è¿›ç¨‹ã€‚

   ```bash
   kill -WINCH <old_master_process_id>
   ```

   ä¸Šè¿°å‘½ä»¤ä¼šåœæ­¢æ—§çš„å·¥ä½œè¿›ç¨‹ï¼Œæ–°çš„è¿›ç¨‹å°†å®Œå…¨æ¥ç®¡ã€‚

6. **(å¯é€‰) å›æ»šåˆ°æ—§ç‰ˆæœ¬**ï¼š

   å¦‚æœæ–°ç‰ˆæœ¬å‡ºç°é—®é¢˜ï¼Œå¯ä»¥å‘é€ `HUP` ä¿¡å·å›æ»šåˆ°æ—§ç‰ˆæœ¬ã€‚

   ```bash
   mv /usr/sbin/nginx.backup /usr/sbin/nginx
   kill -HUP <new_master_process_id>
   ```

ğŸ“¢ æ³¨æ„äº‹é¡¹ï¼š

* ç¡®ä¿åœ¨è¿›è¡Œå‡çº§å‰å¤‡ä»½å¥½ç°æœ‰çš„ Nginx äºŒè¿›åˆ¶æ–‡ä»¶å’Œé…ç½®æ–‡ä»¶ã€‚

* å¹³æ»‘å‡çº§æ“ä½œé€šå¸¸ä¸ä¼šä¸­æ–­ç°æœ‰è¿æ¥ï¼Œä½†ç¡®ä¿åœ¨æµé‡è¾ƒå°‘çš„æ—¶é—´æ®µè¿›è¡Œæ“ä½œä»¥å‡å°‘é£é™©ã€‚

* åœ¨å‡çº§å‰ï¼Œå¯ä»¥é€šè¿‡ `nginx -t` æ£€æŸ¥é…ç½®æ–‡ä»¶è¯­æ³•ï¼Œé¿å…å› é…ç½®é”™è¯¯å¯¼è‡´å‡çº§å¤±è´¥ã€‚

## :star:åå‘ä»£ç†

ä»£ç†ï¼ˆProxyï¼‰ä¹Ÿç§°ç½‘ç»œä»£ç†ã€‚å®ƒæ˜¯ä¸€ç§ç‰¹æ®Šçš„ç½‘ç»œæœåŠ¡ï¼Œå…è®¸ä¸€ä¸ªç½‘ç»œç»ˆç«¯ï¼ˆä¸€èˆ¬ä¸ºå®¢æˆ·ç«¯ï¼‰é€šè¿‡è¿™
ä¸ªæœåŠ¡ä¸å¦ä¸€ä¸ªç½‘ç»œç»ˆç«¯ï¼ˆä¸€èˆ¬ä¸ºæœåŠ¡å™¨ï¼‰è¿›è¡Œéç›´æ¥çš„è¿æ¥ã€‚

ä¸€äº›ç½‘å…³ã€è·¯ç”±å™¨ç­‰ç½‘ç»œè®¾å¤‡å…·å¤‡ç½‘ç»œä»£ç†åŠŸèƒ½ã€‚

ä¸€èˆ¬è®¤ä¸ºä»£ç†æœåŠ¡æœ‰åŠ©äºä¿éšœç½‘ç»œç»ˆç«¯çš„éšç§æˆ–å®‰å…¨ï¼Œé˜²æ­¢æ”»å‡»ã€‚ä»£ç†é€šå¸¸åˆ†ä¸ºæ­£å‘ä»£ç†ã€åå‘ä»£ç†åŠé€æ˜ä»£ç†ã€‚

1. æ­£å‘ä»£ç†ï¼š

   ç›®çš„ï¼šå†…ç½‘çš„æœåŠ¡å™¨é€šè¿‡ä»£ç†æœåŠ¡å™¨ï¼Œç„¶åèƒ½å¤Ÿè®¿é—®å¤–ç½‘çš„æœåŠ¡å™¨

   åŸç†ï¼šå†…ç½‘ç”¨æˆ·å°†è¯·æ±‚å‘ç»™ä»£ç†æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨æ ¹æ®ç”¨æˆ·éœ€æ±‚ï¼Œå‘çœŸæ­£çš„webæœåŠ¡å™¨å‘å‡ºè¯·æ±‚ï¼Œç„¶åè·å–åˆ°ç½‘é¡µå†…å®¹ä¹‹åï¼Œåœ¨æœ¬åœ°ç¼“å­˜ç„¶åå‘ç»™ç”¨æˆ·ã€‚

2. é€æ˜ä»£ç†æœåŠ¡å™¨

   ç›®çš„å’ŒåŸç†ä¸æ­£å‘ä»£ç†æœåŠ¡å™¨ä¸€è‡´ï¼Œä½†ä¸€èˆ¬å¸ƒç½²åœ¨ç½‘å…³ä¸Š,ç”¨æˆ·ä¸éœ€è¦å†å¯¹æµè§ˆå™¨è¿›è¡Œè®¾ç½®

3. åå‘ä»£ç†

   ç›®çš„ï¼šå¤–ç½‘å®¢æˆ·ç«¯é€šè¿‡ä»£ç†æœåŠ¡å™¨ï¼Œèƒ½å¤Ÿè®¿é—®å†…ç½‘æœåŠ¡å™¨çš„èµ„æº

   åŸç†ï¼šå¤–ç½‘å®¢æˆ·ç«¯è®¿é—®æ­£å¸¸çš„åŸŸåæˆ–è€…IPï¼Œå…¶å®è®¿é—®çš„æ˜¯ä»£ç†æœåŠ¡å™¨ï¼Œä»£ç†æœåŠ¡å™¨å¸®åŠ©å®¢æˆ·ç«¯è¯·æ±‚é¡µé¢ï¼Œåœ¨ä»£ç†æœåŠ¡å™¨ä¸Šç¼“å­˜ï¼Œç„¶åå†å‘é€ç»™å®¢æˆ·ç«¯ã€‚

### ä¸ƒå±‚ä»£ç†

nginxåå‘ä»£ç†åŠŸèƒ½ç”± ngx_http_proxy_module æ¨¡å—æä¾›

1. é…ç½®åå‘ä»£ç†

   ```nginx
   location / {
       proxy_pass  http://192.168.10.12;
   }
   ```

   ä»¥ä¸Šé…ç½®å°†æ‰€æœ‰çš„è®¿é—®è¯·æ±‚ä»£ç†åˆ°åç«¯æœåŠ¡å™¨ http://192.168.10.12 ä¸Š

   å½“æˆ‘ä»¬é…ç½®å¥½åå‘ä»£ç†åï¼Œä½¿ç”¨å®¢æˆ·ç«¯è®¿é—®ä»£ç†æœåŠ¡å™¨ï¼Œå°†èƒ½è·å–åç«¯çœŸå®æœåŠ¡å™¨çš„å†…å®¹

2. çœŸå®IP

    1. é…ç½®ä»£ç†æœåŠ¡å™¨å°†å®¢æˆ·ç«¯ IP ä¼ é€’ç»™åç«¯æœåŠ¡å™¨

       æŸ¥çœ‹åç«¯æœåŠ¡å™¨çš„è®¿é—®æ—¥å¿—ï¼Œæˆ‘ä»¬å‘ç°æ—¥å¿—ä¸­è®°å½•çš„å®¢æˆ·ç«¯ IP å¹¶éçœŸå®å®¢æˆ·ç«¯çš„ IPï¼Œè€Œæ˜¯ä»£ç†æœåŠ¡å™¨çš„ IP ã€‚æ˜¾ç„¶ï¼Œè®°å½•è¿™ä¸ª IP æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚

       ç”±äºåç«¯æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯å¹¶æ²¡æœ‰ç›´æ¥çš„é€šä¿¡ï¼Œæ‰€ä»¥å®¢æˆ·ç«¯çš„çœŸå® IP åªèƒ½é€šè¿‡ä»£ç†æœåŠ¡å™¨ä¼ é€’ç»™åç«¯æœåŠ¡å™¨ã€‚æˆ‘ä»¬å¯ä»¥åœ¨ä»£ç†æœåŠ¡å™¨ä¸Šå°†å®¢æˆ·ç«¯çš„ IP å°è£…åˆ°è¯·æ±‚æŠ¥æ–‡ä¸­å‘é€ç»™åç«¯æœåŠ¡å™¨ã€‚

       ```nginx
       location / {
           proxy_pass http://webs;
           proxy_set_header X-Real-IP $remote_addr; # å°† $remote_addr çš„å€¼å°è£…åˆ°è¯·æ±‚æŠ¥æ–‡å¤´éƒ¨çš„ X-Real-IP å­—æ®µä¸­
       }
       ```

    2. é…ç½®åç«¯ web æœåŠ¡å™¨è®°å½•ä¸‹å®¢æˆ·ç«¯çœŸå® IP

       è™½ç„¶ç»è¿‡ä»¥ä¸Šç¬¬1æ­¥é…ç½®ï¼Œä»£ç†èƒ½å¤Ÿå°†å®¢æˆ·ç«¯çœŸå® IP ä¼ é€’è¿‡æ¥äº†ï¼Œä½†é»˜è®¤æƒ…å†µä¸‹åç«¯æœåŠ¡å™¨å¹¶ä¸ä¼šåœ¨æ—¥å¿—ä¸­è®°å½•è¯·æ±‚å¤´éƒ¨ X-Real-IP å­—æ®µçš„å€¼ã€‚

        * ç®€å•é…ç½®

          å¦‚æœåç«¯ä¸ºnginxï¼Œæœ‰ä¸¤ç§æ–¹æ³•å¯å®ç°æœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯ç›´æ¥ä¿®æ”¹ log_format ï¼Œå°† `$remote_addr` æ”¹ä¸º $http_x_real_ip å³å¯

          ä¸Šè¿°é…ç½®æ–¹æ³•æœ€ä¸ºç®€å•ï¼Œä½†æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå®¢æˆ·ç«¯ç›´æ¥è®¿é—®ï¼ˆä¸é€šè¿‡ä»£ç†æœåŠ¡å™¨ï¼‰æ—¶æ²¡æœ‰IP

        * ä½¿ç”¨æ¨¡å—å¤„ç†

          nginxæœåŠ¡å™¨å¯é€šè¿‡ ngx_http_realip_module æ¨¡å—è·å–çœŸå® IP

          ```nginx
          server {
          ...
              set_real_ip_from ä»£ç†æœåŠ¡å™¨IP;
              real_ip_header X-Real-IP;
              ...
          }
          ```

          è¿™æ ·é…ç½®åï¼Œ$remote_addr çš„å€¼å°†ä¼šä»è¯·æ±‚æŠ¥æ–‡ä¸­çš„ X-Real-IP å­—æ®µä¸­è·å–ã€‚

#### proxy_pass è¯¦è§£

proxy_passæ˜¯åå‘ä»£ç†æœ€æ ¸å¿ƒçš„æŒ‡ä»¤ã€‚ä»£ç†æ—¶ï¼Œåé¢å¦‚æœæœ‰è·¯å¾„ï¼Œå°†æ›¿æ¢locationéƒ¨åˆ†ï¼›å¦åˆ™ï¼Œå°†æ‰€æœ‰è·¯å¾„æ‹¼æ¥åˆ°åé¢ã€‚

```nginx
location /static/ {
    proxy_pass  http://192.168.10.12;   # åé¢ä¸æ¥ä»»ä½•è·¯å¾„ï¼Œæ‰€æœ‰URLè·¯å¾„å°†è¢«æ‹¼æ¥åˆ°åé¢
}
# å°†è¢«ä»£ç†åˆ°ï¼šhttp://192.168.10.12/static/index.html

location /static/ {
    proxy_pass  http://192.168.10.12/;
}
# http://192.168.10.12/index.html

location /static/ {
    proxy_pass  http://192.168.10.12/abc;
}
# å°†è¢«ä»£ç†åˆ°ï¼šhttp://192.168.10.12/abcindex.html

location /static/ {
    proxy_pass  http://192.168.10.12/abc/;
}
# å°†è¢«ä»£ç†åˆ°ï¼šhttp://192.168.10.12/abc/index.html
```

### å››å±‚ä»£ç†

nginx ä¹Ÿæ”¯æŒåšå››å±‚ä»£ç†ï¼Œä¸è¿‡å®é™…åº”ç”¨è¾ƒå°‘ï¼Œå› ä¸ºå››å±‚è°ƒåº¦é€šå¸¸ä½¿ç”¨ LVS æ¥åš

nginx å››å±‚ä»£ç†ç”± ngx_stream_proxy_module æ¨¡å—æä¾›

## :star2:è´Ÿè½½å‡è¡¡

è¯¥åŠŸèƒ½ç”± ngx_http_upstream_module + ngx_http_proxy_module æ¨¡å—æä¾›

å½“æˆ‘ä»¬æŠŠåç«¯æœåŠ¡å™¨æ¢æˆåç«¯æœåŠ¡å™¨ç»„åï¼Œæ­¤ä»£ç†æœåŠ¡å™¨ä¾¿æˆäº†è´Ÿè½½å‡è¡¡è°ƒåº¦å™¨

> æœåŠ¡å™¨ç»„çš„é…ç½®

ä½¿ç”¨ upstream æŒ‡ä»¤é…ç½®æœåŠ¡å™¨ç»„ï¼Œä¸€ä¸ª http å—ä¸­å¯é…ç½®å¤šä¸ªæœåŠ¡å™¨ç»„ã€‚

```nginx
upstream  backend {
    server 192.168.10.11 weight=5;
    server 127.0.0.1:8080 max_fails=3  fail_timeout=3s;
    server 192.168.10.12 down;
    server 192.168.10.13 backup;
}

# weight=N               å®šä¹‰æƒå€¼ï¼Œé»˜è®¤ä¸º1
# max_conns=N            é™åˆ¶æœ€å¤§è¿æ¥æ•°
# backup                 å¤‡ç”¨æœåŠ¡å™¨ï¼Œå½“æ‰€æœ‰æœåŠ¡å™¨éƒ½å®•æœºåæ‰ä¼šèµ·ç”¨
# down                   ä¸èµ·ç”¨çš„æœåŠ¡å™¨
# max_fails=N            è®¤ä¸ºåç«¯æœåŠ¡å™¨å¤±æ•ˆçš„è¿æ¥å¤±è´¥æ¬¡æ•°
# fail_timeout=Ns        å¿ƒè·³æ£€æµ‹å“åº”è¶…æ—¶ç§’æ•°ï¼Œè¶…è¿‡è¿™ä¸ªæ—¶é—´æœªå“åº”åˆ™è®¤ä¸ºå¤±è´¥
```

> é…ç½®è´Ÿè½½å‡è¡¡

```nginx
server {
    location / {
        proxy_pass  http://backend;        # å°†è¯·æ±‚ä»£ç†åˆ°æœåŠ¡å™¨ç»„ä¸­ï¼Œå³è´Ÿè½½å‡è¡¡
    }
}
```

### è°ƒåº¦ç®—æ³•

1. è½®è¯¢

2. åŠ æƒè½®è¯¢

   ```nginx
   upstream backend {
       server backend1.example.com weight=3;
       server backend2.example.com weight=1;
       server backend3.example.com weight=2;
   }
   ```

3. ip_hash

   ```nginx
   upstream backend {
       ip_hash;
       server backend1.example.com;
       server backend2.example.com;
       server backend3.example.com;
   }
   ```

4. least_conn æœ€å°‘è¿æ¥æ•°

   å°†è¯·æ±‚ä¼ é€’åˆ°æ´»åŠ¨è¿æ¥æ•°æœ€å°‘çš„æœåŠ¡å™¨ï¼ŒåŒæ—¶è€ƒè™‘æœåŠ¡å™¨çš„æƒé‡ã€‚

   ```nginx
   upstream backend {
       least_conn;
       server backend1.example.com;
       server backend2.example.com;
       server backend3.example.com;
   }
   ```

5. å…¬å¹³ï¼ˆFairï¼‰

   å°†è¯·æ±‚åˆ†é…ç»™å“åº”æ—¶é—´æœ€çŸ­çš„æœåŠ¡å™¨ï¼Œé€‚åˆå¯¹å“åº”æ—¶é—´è¦æ±‚è¾ƒé«˜çš„åœºæ™¯ã€‚

   éœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å— `ngx_http_upstream_fair_module`ã€‚

6. URL å“ˆå¸Œï¼ˆURL Hashï¼‰

   é€šè¿‡è®¡ç®—è¯·æ±‚ URL çš„å“ˆå¸Œå€¼ï¼Œå°†ç›¸åŒ URL çš„è¯·æ±‚åˆ†é…ç»™åŒä¸€å°åç«¯æœåŠ¡å™¨ã€‚

   é€‚ç”¨äºç¼“å­˜æœåŠ¡å™¨ï¼Œç¡®ä¿ç›¸åŒ URL çš„è¯·æ±‚å‘½ä¸­ç›¸åŒçš„ç¼“å­˜ã€‚

   éœ€è¦ç¬¬ä¸‰æ–¹æ¨¡å— `ngx_http_upstream_hash_module`ã€‚

## ç¼“å­˜

ç¼“å­˜ä¸€èˆ¬å­˜çš„æ˜¯é™æ€èµ„æº

ç¼“å­˜å¯ä»¥æé«˜å®¢æˆ·ç«¯çš„è®¿é—®é€Ÿåº¦,å¹¶èƒ½å‡è½»æœåŠ¡å™¨çš„å‹åŠ›

æˆ‘ä»¬åˆ†åˆ«ä»å®¢æˆ·ç«¯ç¼“å­˜åŠæœåŠ¡å™¨ç«¯ç¼“å­˜ä¸¤ä¸ªåœºæ™¯å»åˆ†æ

1. å®¢æˆ·ç«¯ç¼“å­˜

   é€šè¿‡è®¾ç½® expires æŒ‡ä»¤ï¼Œå“åº”å¤´ä¸­å°†ä¼šè¿”å›Expires å’ŒCache-Controlå­—æ®µã€‚

   å½“æµè§ˆå™¨å‘ç°å“åº”å¤´å­˜åœ¨è¿™æ ·çš„ç¼“å­˜å­—æ®µï¼Œå½“å†æ¬¡è¯·æ±‚ç›¸åŒèµ„æºæ—¶ï¼Œå°±ä¼šç¡®è®¤åœ¨å®¢æˆ·ç«¯çš„èµ„æºæ˜¯å¦è¿‡æœŸã€‚æµè§ˆå™¨åœ¨ä¸å¼ºåˆ¶åˆ·æ–°çš„æƒ…å†µä¸‹å¯ä½¿ç”¨æœ‰æ•ˆæœŸå†…çš„ç¼“å­˜ã€‚

   ```nginx
   location /images/ {
       root /data/www;
       expires 30d;
   }
   ```

2. æœåŠ¡å™¨ç¼“å­˜ï¼ˆä¸»è¦è®¾ç½®åå‘ä»£ç†æœåŠ¡å™¨ï¼‰

   å¦‚æœæˆ‘ä»¬èƒ½å°†é™æ€èµ„æºçš„ç¼“å­˜è®¾ç½®åœ¨æœåŠ¡å™¨ç«¯ï¼Œå½“å¤šä¸ªç”¨æˆ·è®¿é—®åŒä¸€ä¸ªèµ„æºæ—¶ï¼Œç¼“å­˜å‘½ä¸­ç‡åŠç³»ç»Ÿçš„æ€§èƒ½å°†ä»¥æŒ‡æ•°çš„å½¢å¼æå‡ã€‚

   ç”¨äºç¼“å­˜ä»åç«¯æœåŠ¡å™¨ï¼ˆå¦‚åº”ç”¨æœåŠ¡å™¨æˆ–å…¶ä»– HTTP æœåŠ¡å™¨ï¼‰è·å–çš„å“åº”æ•°æ®ã€‚é€‚åˆç¼“å­˜åŠ¨æ€å†…å®¹å’Œå¤–éƒ¨æœåŠ¡çš„å“åº”ã€‚

   ```nginx
   http {
       proxy_cache_path /var/cache/nginx levels=1:2 keys_zone=my_cache:10m max_size=10g;
       server {
           location / {
               proxy_cache my_cache;
               proxy_pass http://backend;
               proxy_cache_valid 200 302 10m;
               proxy_cache_valid 404 1m;
           }
       }
   }
   ```

   `proxy_cache_path`ï¼šæŒ‡å®šç¼“å­˜çš„è·¯å¾„å’Œä¸€äº›å…¶ä»–å‚æ•°ï¼Œç¼“å­˜çš„æ•°æ®å­˜å‚¨åœ¨æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”ä½¿ç”¨ä»£ç†urlçš„å“ˆå¸Œå€¼ä½œä¸ºå…³é”®å­—ä¸æ–‡ä»¶åã€‚

    * `levels`- ç›®å½•ç»“æ„ï¼Œå¯ä»¥ä½¿ç”¨ä»»æ„çš„1ä½æˆ–2ä½æ•°å­—ä½œä¸ºç›®å½•ç»“æ„ï¼Œå¦‚ X, X:Xæˆ–X:X:X ,æœ€å¤šä¸‰çº§ã€‚
    * `keys_zone` - æŒ‡å®šæ‰€æœ‰æ´»åŠ¨çš„keyå’Œå…ƒæ•°æ®å­˜å‚¨çš„å…±äº«å†…å­˜æ± åŒºåŸŸã€‚  10åˆ†é’Ÿè¿‡æœŸ
    * `max_size` - å®šä¹‰æœ€å¤§ç¼“å­˜å¤§å°,è¶…å‡ºååˆ™åˆ é™¤æœ€å°‘ä½¿ç”¨çš„æ•°æ®

   `proxy_cache`ï¼šè®¾ç½®ä¸€ä¸ªç¼“å­˜åŒºåŸŸçš„åç§°ï¼Œä¸€ä¸ªç›¸åŒçš„åŒºåŸŸå¯ä»¥åœ¨ä¸åŒçš„åœ°æ–¹ä½¿ç”¨ã€‚

   `proxy_cache_valid`ï¼šä¸ºåº”ç­”ä»£ç ä¸º200å’Œ302çš„è®¾ç½®ç¼“å­˜æ—¶é—´ä¸º10åˆ†é’Ÿï¼Œ404ä»£ç ç¼“å­˜1åˆ†é’Ÿã€‚

## çŠ¶æ€ç é—®é¢˜

401 æˆæƒçš„é—®é¢˜
404 é¡µé¢æ‰¾ä¸åˆ°
403 è®¿é—®è¢«æ‹’ç»

nginxçš„500,502,504é”™è¯¯

> **500é”™è¯¯ï¼š**

500é”™è¯¯æŒ‡çš„æ˜¯æœåŠ¡å™¨å†…éƒ¨é”™è¯¯,ä¹Ÿå°±æ˜¯æœåŠ¡å™¨é‡åˆ°æ„å¤–æƒ…å†µ,è€Œæ— æ³•å±¥è¡Œè¯·æ±‚.

500é”™è¯¯ä¸€èˆ¬æœ‰å‡ ç§æƒ…å†µ:

1. ç¨‹åºè¯­æ³•é”™è¯¯
2. è®¿é—®é‡è¿‡å¤§
3. æœåŠ¡å™¨é…ç½®é—®é¢˜
4. æ•°æ®åº“ã€ç¼“å­˜ä¸å¯ç”¨

500é”™è¯¯åˆ†ææ€è·¯ï¼š

1. æŸ¥çœ‹ nginx é”™è¯¯æ—¥å¿—

   `connect() failed (111: Connection refused)`ï¼šè¡¨ç¤º Nginx æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨ï¼Œå¯èƒ½æ˜¯åç«¯æœåŠ¡æœªå¯åŠ¨æˆ–ç«¯å£é”™è¯¯ã€‚

   `upstream timed out (110: Connection timed out)`ï¼šè¡¨ç¤ºè¯·æ±‚åˆ°è¾¾åç«¯æœåŠ¡å™¨æ—¶è¶…æ—¶ï¼Œå¯èƒ½æ˜¯åç«¯æœåŠ¡å“åº”ç¼“æ…¢æˆ–è´Ÿè½½è¿‡é«˜ã€‚

2. æ£€æŸ¥åç«¯æœåŠ¡å™¨

   **åç«¯æœåŠ¡çŠ¶æ€**ï¼šç¡®è®¤åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œï¼Œå¯ä»¥é€šè¿‡è®¿é—®åç«¯æœåŠ¡çš„å¥åº·æ£€æŸ¥ URL æˆ–ç›´æ¥è®¿é—®åç«¯æœåŠ¡æ¥æµ‹è¯•å…¶å¯ç”¨æ€§ã€‚

   **ç½‘ç»œè¿æ¥**ï¼šæ£€æŸ¥ Nginx å’Œåç«¯æœåŠ¡å™¨ä¹‹é—´çš„ç½‘ç»œè¿æ¥ï¼Œç¡®ä¿å®ƒä»¬ä¹‹é—´çš„é€šä¿¡æ­£å¸¸ã€‚å¯ä»¥ä½¿ç”¨ `telnet` æˆ– `curl` å‘½ä»¤æ¥æµ‹è¯•è¿æ¥ã€‚

3. è´Ÿè½½å‡è¡¡é…ç½®

   **æƒé‡é…ç½®**ï¼šæ£€æŸ¥è´Ÿè½½å‡è¡¡å™¨ä¸­å„ä¸ªæœåŠ¡å™¨çš„æƒé‡æ˜¯å¦é…ç½®æ­£ç¡®ï¼Œç¡®ä¿è´Ÿè½½å‡è¡¡ç®—æ³•æ²¡æœ‰é—®é¢˜ã€‚

   **å¥åº·æ£€æŸ¥**ï¼šç¡®ä¿ Nginx é…ç½®äº†åç«¯æœåŠ¡å™¨çš„å¥åº·æ£€æŸ¥ï¼Œé¿å…å°†è¯·æ±‚åˆ†å‘åˆ°ä¸å¯ç”¨çš„æœåŠ¡å™¨ä¸Šã€‚

4. èµ„æºé™åˆ¶

   **Nginx ç³»ç»Ÿèµ„æºé™åˆ¶**ï¼šæ£€æŸ¥ç³»ç»Ÿçš„èµ„æºé™åˆ¶ï¼ˆå¦‚å†…å­˜ã€CPUã€æ–‡ä»¶å¥æŸ„æ•°ï¼‰ï¼Œçœ‹çœ‹æ˜¯å¦è¾¾åˆ°äº†ç“¶é¢ˆã€‚Nginx æœ‰æ—¶å¯èƒ½å› ä¸ºç³»ç»Ÿèµ„æºä¸è¶³è€Œæ— æ³•æ­£å¸¸å¤„ç†è¯·æ±‚ã€‚

   **è¿æ¥æ•°é™åˆ¶**ï¼šæ£€æŸ¥ Nginx çš„è¿æ¥æ•°é™åˆ¶å’Œåç«¯æœåŠ¡çš„è¿æ¥æ•°é™åˆ¶ï¼Œç¡®ä¿æ²¡æœ‰å› ä¸ºè¿æ¥æ•°è¿‡å¤šå¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚

5. å…¶ä»–çš„æ½œåœ¨é—®é¢˜

   ç¼“å­˜é—®é¢˜ï¼šå¦‚æœä½¿ç”¨äº†ç¼“å­˜ï¼ˆå¦‚ `proxy_cache`ï¼‰ï¼Œå¯èƒ½æ˜¯ç¼“å­˜é…ç½®å¯¼è‡´äº†é—®é¢˜ã€‚å¯ä»¥é€šè¿‡ç¦ç”¨ç¼“å­˜æ¥æµ‹è¯•ã€‚

   SSL/TLSé—®é¢˜ï¼šå¦‚æœä½¿ç”¨äº† SSL/TLS ç»ˆæ­¢ï¼Œæ£€æŸ¥è¯ä¹¦å’Œ SSL é…ç½®æ˜¯å¦æ­£ç¡®ã€‚

>  502 é”™è¯¯ï¼ˆBad Gatewayï¼‰

é€šå¸¸è¡¨ç¤º Nginx æ— æ³•ä¸åç«¯æœåŠ¡å™¨å»ºç«‹æ­£ç¡®çš„è¿æ¥æˆ–æ¥æ”¶åˆ°æœ‰æ•ˆçš„å“åº”ã€‚ä»¥ä¸‹æ˜¯ä¸€äº›å¸¸è§çš„æ’æŸ¥æ€è·¯å’Œæ­¥éª¤ï¼š

502é”™è¯¯å‘ç”Ÿåœ¨nginxä¸ºä»£ç†æœåŠ¡å™¨çš„æƒ…å†µä¸‹ï¼Œå¦‚ä¸Šæ¸¸åº”ç”¨æœåŠ¡å™¨ä¸å¯ç”¨ï¼Œè°ƒåº¦æ— æ³•å®Œæˆå°±ä¼šæŠ¥502é”™è¯¯ã€‚
502é”™è¯¯ä»ä¸Šæ¸¸æœåŠ¡å™¨æ‰¾åŸå› 

> è§£å†³503é”™è¯¯  é™æµ

503 Service Temporarily Unavailableé”™è¯¯

è¡¨ç¤ºæœåŠ¡å™¨æš‚æ—¶æ— æ³•å¤„ç†è¯·æ±‚ã€‚è¿™é€šå¸¸æ˜¯å› ä¸ºæœåŠ¡å™¨è¿‡è½½ã€ç»´æŠ¤æˆ–æš‚æ—¶ä¸å¯ç”¨ã€‚ä»¥ä¸‹æ˜¯ 503 é”™è¯¯çš„å¸¸è§åŸå› å’Œå¯¹åº”çš„æ’æŸ¥æ€è·¯ï¼š

å•ä¸ªipå¹¶å‘è®¾ç½®è¿‡å°ä¼šå¯¼è‡´503æŠ¥é”™

1. æœåŠ¡å™¨è¿‡è½½
2. æœåŠ¡å™¨ç»´æŠ¤å’Œå‡çº§ï¼Œæš‚æ—¶ä¸‹çº¿
3. åç«¯æœåŠ¡ä¸å¯ç”¨
4. èµ„æºè€—å°½
5. é™æµç­–ç•¥

## åŠ¨é™åˆ†ç¦»

å‰ç«¯ä½¿ç”¨ VUEï¼Œåç«¯ä½¿ç”¨ Spring Bootã€‚

é€šå¸¸æƒ…å†µä¸‹ï¼ŒVue åº”ç”¨æ˜¯ä¸€ä¸ªå•é¡µåº”ç”¨ç¨‹åºï¼ˆSPAï¼‰ï¼Œç»è¿‡æ„å»ºåç”Ÿæˆé™æ€æ–‡ä»¶ï¼ˆå¦‚ HTMLã€CSSã€JavaScriptï¼‰ï¼Œè¿™äº›é™æ€æ–‡ä»¶å¯ä»¥ç›´æ¥ç”± Nginx æä¾›ï¼Œè€ŒåŠ¨æ€è¯·æ±‚åˆ™é€šè¿‡ Nginx ä»£ç†åˆ° Spring Boot å¤„ç†ã€‚

å‡è®¾ Vue é¡¹ç›®æ„å»ºåçš„é™æ€æ–‡ä»¶ä½äº `/var/www/vue-app`ï¼ŒSpring Boot åº”ç”¨è¿è¡Œåœ¨ `http://localhost:8080`ã€‚

```nginx
server {
    listen 80;
    server_name example.com;

    # é™æ€æ–‡ä»¶ï¼ˆVue åº”ç”¨ï¼‰
    location / {
        root /var/www/vue-app;
        try_files $uri $uri/ /index.html;
    }

    # åŠ¨æ€è¯·æ±‚ï¼ˆSpring Boot APIï¼‰
    location /api/ {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
```

**CORS é…ç½®**ï¼šå¦‚æœå‰ç«¯å’Œåç«¯ä¸åœ¨åŒä¸€ä¸ªåŸŸä¸‹ï¼Œéœ€è¦é…ç½®è·¨åŸŸèµ„æºå…±äº«ï¼ˆCORSï¼‰ã€‚

## æ—¥å¿—è½®è½¬

æ—¥å¿—è½®è½¬ï¼ˆLog Rotationï¼‰æ˜¯ç®¡ç†æ—¥å¿—æ–‡ä»¶çš„è¿‡ç¨‹ï¼Œæ—¨åœ¨é˜²æ­¢æ—¥å¿—æ–‡ä»¶æ— é™å¢é•¿ï¼Œå ç”¨è¿‡å¤šç£ç›˜ç©ºé—´ã€‚å®ƒæ¶‰åŠå®šæœŸå°†å½“å‰çš„æ—¥å¿—æ–‡ä»¶å½’æ¡£å¹¶åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚è¿™é€šå¸¸æ˜¯é€šè¿‡ä»¥ä¸‹æ­¥éª¤å®Œæˆçš„ï¼š

1. **å½’æ¡£**ï¼š
    - å½“å‰çš„æ—¥å¿—æ–‡ä»¶è¢«é‡å‘½åæˆ–ç§»åŠ¨åˆ°ä¸€ä¸ªå­˜æ¡£ä½ç½®ï¼Œé€šå¸¸ä¼šåŠ ä¸Šæ—¶é—´æˆ³æˆ–åºåˆ—å·ã€‚ä¾‹å¦‚ï¼Œ`app.log` å¯èƒ½è¢«é‡å‘½åä¸º `app.log.2024-08-17`ã€‚
2. **åˆ›å»ºæ–°æ—¥å¿—æ–‡ä»¶**ï¼š
    - åœ¨å½’æ¡£åï¼Œç³»ç»Ÿä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œç»§ç»­è®°å½•æ–°çš„æ—¥å¿—æ•°æ®ã€‚è¿™å¯ä»¥æ˜¯æ–°çš„ `app.log` æ–‡ä»¶ã€‚
3. **ç®¡ç†å’Œåˆ é™¤æ—§æ—¥å¿—**ï¼š
    - æ—§çš„æ—¥å¿—æ–‡ä»¶å¯èƒ½ä¼šè¢«å‹ç¼©ä»¥èŠ‚çœç©ºé—´ï¼Œæˆ–è€…æ ¹æ®è®¾å®šçš„ç­–ç•¥ï¼ˆå¦‚ä¿ç•™ä¸€å®šå¤©æ•°æˆ–æ–‡ä»¶æ•°é‡ï¼‰è¢«åˆ é™¤ã€‚

**æ—¥å¿—è½®è½¬çš„ä¸»è¦å¥½å¤„**ï¼š

- **é˜²æ­¢ç£ç›˜è€—å°½**ï¼šå®šæœŸè½®è½¬æ—¥å¿—æ–‡ä»¶å¯ä»¥é˜²æ­¢æ—¥å¿—æ–‡ä»¶å ç”¨è¿‡å¤šç£ç›˜ç©ºé—´ã€‚
- **æé«˜æ€§èƒ½**ï¼šè¾ƒå°çš„æ—¥å¿—æ–‡ä»¶å¯ä»¥æé«˜ç³»ç»Ÿçš„å†™å…¥å’Œè¯»å–æ€§èƒ½ã€‚
- **ç®€åŒ–æ—¥å¿—ç®¡ç†**ï¼šå°†æ—¥å¿—æ–‡ä»¶å½’æ¡£åˆ°å•ç‹¬çš„æ–‡ä»¶æˆ–ç›®å½•ä¸­ï¼Œä¾¿äºæ—¥å¿—åˆ†æå’Œç®¡ç†ã€‚

### Logrotate

åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¾‹å¦‚ `/etc/logrotate.d/nginx`ï¼Œå¹¶æ·»åŠ å¦‚ä¸‹å†…å®¹ï¼š

```shell
/var/log/nginx/*.log {
    daily			# æ¯å¤©è½®è½¬æ—¥å¿—ã€‚
    missingok
    rotate 14		# ä¿ç•™æœ€è¿‘ 14 ä¸ªå½’æ¡£æ—¥å¿—
    compress		# å‹ç¼©
    delaycompress	# å»¶è¿Ÿå‹ç¼©ä¸Šä¸€ä¸ªè½®è½¬å‘¨æœŸçš„æ—¥å¿—æ–‡ä»¶
    notifempty		# å¦‚æœæ—¥å¿—æ–‡ä»¶ä¸ºç©ºï¼Œåˆ™ä¸è½®è½¬
    create 0640 www-data adm	# åˆ›å»ºæ–°çš„æ—¥å¿—æ–‡ä»¶æ—¶è®¾ç½®æƒé™å’Œæ‰€æœ‰è€…
    sharedscripts
    postrotate	# åœ¨æ—¥å¿—è½®è½¬åï¼Œå‘é€ä¿¡å·ç»™ Nginx é‡æ–°æ‰“å¼€æ—¥å¿—æ–‡ä»¶
        if [ -f /run/nginx.pid ]; then
            /bin/kill -USR1 `cat /run/nginx.pid`
        fi
    endscript
}
```

### è‡ªå®šä¹‰è„šæœ¬

å¯ä»¥ç¼–å†™è‡ªå®šä¹‰è„šæœ¬æ¥å¤„ç† Nginx æ—¥å¿—è½®è½¬ã€‚è¿™äº›è„šæœ¬å¯ä»¥å®šæœŸæ£€æŸ¥æ—¥å¿—æ–‡ä»¶çš„å¤§å°ï¼Œå¹¶åœ¨éœ€è¦æ—¶è½®è½¬æ—¥å¿—æ–‡ä»¶ã€‚

ä½¿ç”¨ cron å®šæœŸæ‰§è¡Œ

ä¸‹é¢è¿™ä¸ªè„šæœ¬ä¼šæ£€æŸ¥æ—¥å¿—æ–‡ä»¶çš„å¤§å°ï¼ˆä¸€ä¸ªä¸­ç­‰æµé‡ç½‘ç«™æ¯å¤©æµé‡å‡ ä¸ª Gï¼‰ï¼Œå¦‚æœè¶…è¿‡æŒ‡å®šé˜ˆå€¼ï¼Œå®ƒå°†é‡å‘½åå½“å‰çš„æ—¥å¿—æ–‡ä»¶ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„æ—¥å¿—æ–‡ä»¶ï¼Œå¹¶é‡æ–°åŠ è½½ Nginx ä»¥ä½¿å…¶å¼€å§‹å†™å…¥æ–°çš„æ—¥å¿—æ–‡ä»¶ã€‚

```shell
#!/bin/bash

# é…ç½®
LOG_DIR="/var/log/nginx"
MAX_SIZE=10485760 # æœ€å¤§æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œå•ä½å­—èŠ‚ï¼ˆè¿™é‡Œæ˜¯10MBï¼‰
DATE=$(date +'%Y-%m-%d')
PID_FILE="/run/nginx.pid"

# å¾ªç¯å¤„ç†æ¯ä¸ªæ—¥å¿—æ–‡ä»¶
for LOG_FILE in $LOG_DIR/*.log; do
    if [ -f "$LOG_FILE" ]; then
        FILE_SIZE=$(stat -c%s "$LOG_FILE")
        if [ "$FILE_SIZE" -gt "$MAX_SIZE" ]; then
            # å½’æ¡£å½“å‰æ—¥å¿—æ–‡ä»¶
            mv "$LOG_FILE" "$LOG_FILE.$DATE"
            # åˆ›å»ºæ–°çš„ç©ºæ—¥å¿—æ–‡ä»¶
            touch "$LOG_FILE"
            # é‡æ–°åŠ è½½ Nginx é…ç½®
            if [ -f "$PID_FILE" ]; then
                kill -USR1 $(cat "$PID_FILE")
            fi
        fi
    fi
done


sudo crontab -e
0 1 * * * /usr/local/bin/nginx-logrotate.sh
```

:star:ä½¿ç”¨ `logrotate` æ˜¯æœ€å¸¸è§å’Œæ¨èçš„æ–¹æ¡ˆï¼Œå› ä¸ºå®ƒåŠŸèƒ½å¼ºå¤§ä¸”æ˜“äºé…ç½®ã€‚æ—¥å¿—æ”¶é›†ä½¿ç”¨ ELKï¼ŒåŒæ—¶ä½¿ç”¨`logrotate`æˆ–è€…è‡ªå®šä¹‰è„šæœ¬å®šæ—¶æ¸…ç† Nginx çš„åŸå§‹æ—¥å¿—ã€‚

> æ—¥å¿—åˆ‡å‰²å’Œæ—¥å¿—è½®è½¬ï¼š**æ—¥å¿—åˆ‡å‰²**æŒ‡çš„æ˜¯å°†ä¸€ä¸ªå¤§çš„æ—¥å¿—æ–‡ä»¶åˆ†æˆå¤šä¸ªè¾ƒå°çš„æ–‡ä»¶ã€‚**æ—¥å¿—è½®è½¬**æ˜¯ä¸€ç§æ›´ä¸ºå…¨é¢çš„æ—¥å¿—ç®¡ç†ç­–ç•¥ï¼Œæ¶‰åŠæ—¥å¿—æ–‡ä»¶çš„å½’æ¡£ã€å‹ç¼©å’Œåˆ é™¤ï¼Œä»¥é˜²æ­¢æ—¥å¿—æ–‡ä»¶æ— é™å¢é•¿ã€‚

æ—¥å¿—ä¿å­˜ç­–ç•¥ï¼š

* **çŸ­æœŸä¿å­˜**ï¼šé€šå¸¸ä¿å­˜æœ€è¿‘çš„å‡ å¤©æˆ–å‡ å‘¨çš„æ•°æ®ï¼Œé€‚ç”¨äºå®æ—¶ç›‘æ§å’Œæ•…éšœæ’æŸ¥ã€‚
* **é•¿æœŸå­˜æ¡£**ï¼šå°†æ—¥å¿—æ•°æ®å½’æ¡£åˆ°ä½æˆæœ¬å­˜å‚¨ä¸­ï¼Œä¿å­˜è¾ƒé•¿æ—¶é—´ï¼ˆå¦‚ä¸€å¹´æˆ–æ›´é•¿ï¼‰ï¼Œä»¥æ»¡è¶³åˆè§„æ€§æˆ–é•¿æœŸåˆ†æéœ€æ±‚ã€‚

**æ—¥å¿—æ¸…ç†**ï¼š

- å®šæœŸæ¸…ç†æ—§çš„æ—¥å¿—æ•°æ®ï¼Œä»¥ä¿æŒç³»ç»Ÿçš„æ€§èƒ½å’Œå¯ç”¨ç©ºé—´ã€‚å¯ä»¥é€šè¿‡é…ç½® Logstashã€Elasticsearch æˆ–ä½¿ç”¨å¤–éƒ¨è„šæœ¬æ¥å®ç°ã€‚

## é…ç½®https

1. å®‰è£…ssl æ¨¡å—

   ```
   ./nginx -V  
   ./configure ... --with-http_ssl_module
   make
   ```

2. æ”¾ç½®ssl è¯ä¹¦

   è§£å‹ç¼©ä¸‹è½½å¥½çš„è¯ä¹¦ï¼ˆè¯ä¹¦ä¸€èˆ¬æ˜¯pemæ–‡ä»¶å’Œkeyæ–‡ä»¶ï¼‰

3. è¿›è¡Œnginx.confé…ç½®

   ```nginx
   http {
       include       mime.types;
       default_type  application/octet-stream;
       sendfile        on;
       keepalive_timeout  65;
     server {
     #ç›‘å¬443ç«¯å£
       listen 443;
       #ä½ çš„åŸŸå
       server_name huiblog.top; 
       ssl on;
       #sslè¯ä¹¦çš„pemæ–‡ä»¶è·¯å¾„
       ssl_certificate  /root/card/huiblog.top.pem;
       #sslè¯ä¹¦çš„keyæ–‡ä»¶è·¯å¾„
       ssl_certificate_key /root/card/huiblog.top.key;
       location / {
        proxy_pass  http://å…¬ç½‘åœ°å€:é¡¹ç›®ç«¯å£å·;
       }
   }
   server {
       listen 80;
       server_name huiblog.top;
       #å°†è¯·æ±‚è½¬æˆhttps
       rewrite ^(.*)$ https://$host$1 permanent;
   }
   ```

4. é‡å¯nginx

   `./nginx -s reload `
