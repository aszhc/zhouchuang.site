---
title: Raft共识算法介绍
date: 2024-08-17 23:11:54
permalink: /pages/26355d/
categories:
  - Raft
tags:
  - Raft
  - 分布式
  - 共识算法
author: 
  name: ZhouChuang
  link: https://github.com/aszhc
---

## CAP 理论

分布式系统的一个系统理论，它描述了一个分布式系统最多只能满足以下三个特性的两个：

* 一致性（Consistency）
* 可用性（Availability）
* 分区容错性（Partition tolerance）

## Raft

Raft算法是一种分布式系统中用于实现一致性的共识算法，主要目标是确保在分布式环境中数据的一致性。在分布式系统中，多个节点需要协作处理操作和存储数据，而Raft算法提供了一种有效的方法来协调这些节点，确保整个系统的稳定性和可靠性。

Raft算法的设计哲学强调了易理解性和可操作性。与其他分布式一致性算法（如Paxos）相比，Raft更易于理解和实现，这使得它成为学习和实践分布式系统的理想选择。Raft通过将共识问题分解为几个相对简单的子问题（如领导选举、日志复制等）来降低复杂性。

Raft的核心在于将所有复杂的分布式一致性问题归结为一系列基本的操作和规则，这些操作和规则涵盖了领导选举、日志复制和安全性保证。通过这些机制，Raft确保即便在节点故障或网络问题的情况下，系统状态也能保持一致和完整。

Raft算法广泛应用于各种分布式系统和服务中，特别是在需要高可用性和一致性保证的场景。例如，它被用于分布式数据库、分布式文件系统、云计算服务等多个领域。

## Raft 工作原理

Raft算法的操作可以分为三个关键阶段：**领导选举、日志复制和安全性与一致性维护**。

### 领导选举

在Raft算法中，领导选举是一个关键步骤，确保集群中始终有一个节点充当领导者来协调操作。以下是选举过程的详细说明：

#### 选举触发

选举通常由以下两种情况触发：

1. **集群启动**：当集群启动时，没有现有的领导者，因此会立即开始选举过程。
2. **定时器超时**：每个节点维护一个选举定时器。如果在定时器超时之前没有收到当前领导者的消息，该节点便会触发选举。选举定时器的超时时间随机设定，通常在一个预定范围内，如150到300毫秒。这减少了选举冲突和分裂的可能性，提高领导选举的效率和稳定性。

#### 成为候选者

触发选举的节点会将自己的状态从“跟随者”转变为“候选者”，并执行以下步骤：

1. **增加任期号**：候选者首先增加自己的当前任期号（每次选举都有一个唯一的任期号）。
2. **投票给自己**：候选者给自己投票。
3. **发送请求投票消息**：候选者向集群中的其他节点发送请求投票的消息。

#### 收集选票

集群中的其他节点在收到请求投票消息后会做出响应：

1. **投票规则**：节点只会在当前任期内投票一次。如果接收到的请求来自任期号更高的候选者，节点会更新自己的任期号，并可能投票给该候选者。
2. **日志新鲜度检查**：在投票之前，节点会检查候选者的日志是否至少和自己的一样新。这是通过比较日志中最后一条条目的任期号和索引来决定的。

#### 赢得选举

选举的结果由以下两种情况之一确定：

1. **获得多数票**：如果候选者从集群的大多数节点那里获得了选票，它就成为新的领导者。
2. **选举超时**：如果没有候选者获得多数票（可能因为票数分散或网络问题），选举过程将失败。在这种情况下，节点将重置其选举定时器，并在定时器再次超时时开始新一轮的选举。

#### 新领导者的行动

一旦选出新的领导者，它将开始发送心跳消息（空的附加日志条目）给其他节点，表明领导者的存在并防止新的选举触发。

### 日志复制

日志复制是Raft算法中的核心部分，用于确保分布式系统中所有节点的数据一致性。其过程涉及以下关键步骤：

1. **客户端请求**：日志复制过程始于客户端向领导者发送请求（如数据更新）。
2. **日志条目的创建**：领导者接收到请求后，会将该请求作为一个新的日志条目添加到其日志中。此时，该条目被标记为“未提交”。
3. **日志条目的复制**：随后，领导者将这个新的日志条目发送给集群中的其他节点（跟随者）。领导者需要保持与所有跟随者的持续通信，以确保日志条目得到复制。
4. **跟随者响应**：跟随者接收到新的日志条目后，会将其添加到自己的日志中，并向领导者发送响应，表示已成功接收并记录该条目。
5. **提交日志条目**：一旦领导者从大多数跟随者那里接收到了成功的响应，它便将该日志条目标记为“已提交”。领导者还会通知跟随者哪些条目已经提交。
6. **应用到状态机**：一旦日志条目被提交，领导者和跟随者会将这个条目应用到它们各自的状态机上。这意味着客户端请求的操作被实际执行。
7. **客户端响应**：完成上述步骤后，领导者会向客户端发送响应，表示其请求已经被成功处理。

### 安全性与一致性

在Raft算法中，安全性和一致性是确保系统可靠运行的关键。

1. **安全性**：Raft通过上述机制确保即使在领导者崩溃或网络分区的情况下，集群的状态也始终保持一致。即便在这些情况下，任何已提交的更改都不会丢失，而且任何未提交的更改都不会被错误地应用。
2. **日志一致性保证**：Raft通过严格的日志复制机制来确保所有节点的日志一致性。任何已提交的日志条目都保证在所有节点上存在且顺序相同。
3. **领导者的一致性原则**：Raft算法保证新选举出的领导者拥有所有已提交的日志条目。这是通过在选举过程中对候选者的日志进行“新鲜度”检查来实现的，确保新的领导者具有最新的数据。
4. **提交规则**：一个日志条目从领导者复制到集群中的其他节点后，只有当“大多数”节点都存储了该条目时，它才被认为是“已提交的”。这里的“大多数”意味着超过一半的节点。例如，在一个有五个节点的集群中，至少需要三个节点存储了该条目才能认为它已被提交。
5. **应用日志条目**：一旦一个日志条目被认为是已提交的，它就可以被安全地应用到每个节点的状态机上，因为此时所有节点都已经存储了该条目。
6. **提交与应用的区别**：在Raft中，一个条目被“提交”是指它已经被安全地记录在大多数节点上，而“应用”是指将日志条目的内容实际执行或加入到系统的状态中。

